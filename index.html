<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facial Emotion Detector</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* Dark Professional Design System */
        :root {
            /* Dark theme colors inspired by the reference */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #3a3a3a;

            /* Surface colors */
            --surface-primary: #2d2d2d;
            --surface-secondary: #353535;
            --surface-elevated: #404040;

            /* Accent colors */
            --accent-blue: #4A9EFF;
            --accent-green: #4AFF88;
            --accent-orange: #FF8A4A;
            --accent-red: #FF4A4A;
            --accent-purple: #8A4AFF;

            /* Legacy color mappings for compatibility */
            --apple-blue: #4A9EFF;
            --apple-blue-dark: #3A8EEF;
            --apple-green: #4AFF88;
            --apple-orange: #FF8A4A;
            --apple-red: #FF4A4A;
            --apple-purple: #8A4AFF;

            /* Glass effect colors */
            --glass-bg: rgba(45, 45, 45, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: rgba(0, 0, 0, 0.3);

            /* Background */
            --bg-gradient: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
            --surface-glass: rgba(45, 45, 45, 0.8);
            --surface-glass-hover: rgba(53, 53, 53, 0.8);

            /* Text colors optimized for dark theme */
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --text-tertiary: #808080;
            --text-muted: #606060;
            --separator: rgba(255, 255, 255, 0.1);

            /* Spacing system */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 48px;
            --spacing-xxxl: 64px;

            /* Border radius - minimal */
            --radius-sm: 2px;
            --radius-md: 4px;
            --radius-lg: 6px;
            --radius-xl: 8px;

            /* Minimal shadows */
            --shadow-glass: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-glass-lg: 0 4px 12px rgba(0, 0, 0, 0.15);

            /* Legacy shadow mappings */
            --shadow-sm: var(--shadow-glass);
            --shadow-md: var(--shadow-glass);
            --shadow-lg: var(--shadow-glass-lg);
            --shadow-xl: var(--shadow-glass-lg);
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
            font-weight: 400;
            position: relative;
            letter-spacing: -0.01em;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-gradient);
            z-index: -1;
        }

        .app-container {
            width: 100%;
            min-height: 100vh;
            padding: 0;
            position: relative;
        }



        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            grid-template-rows: 1fr;
            gap: var(--spacing-lg);
            padding: var(--spacing-lg);
            align-items: stretch;
            width: 100%;
            min-height: calc(100vh - 100px);
            position: relative;
            z-index: 2;
        }

        /* Column Layout */
        .info-column {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            height: 100%;
        }

        .content-column {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            height: 100%;
        }

        /* Panel Header */
        .panel-header {
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--separator);
        }

        .panel-header h1 {
            font-size: clamp(1.25rem, 2.5vw, 1.75rem);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }

        .panel-header .subtitle {
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.4;
        }

        .emotion-panel {
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-glass);
            border: 1px solid var(--glass-border);
        }

        .emoji-display {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .emoji {
            font-size: 4rem;
            margin: var(--spacing-md) 0;
            display: block;
            transition: all 0.2s ease;
        }

        .status-text {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--text-primary);
            margin: var(--spacing-sm) 0;
            letter-spacing: -0.01em;
        }

        .status-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 400;
            margin-bottom: var(--spacing-lg);
            line-height: 1.4;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            background: var(--accent-green);
            color: var(--bg-primary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-md);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }

        .video-section {
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-glass);
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .video-header {
            background: var(--surface-secondary);
            color: var(--text-primary);
            padding: var(--spacing-md);
            text-align: center;
            border-bottom: 1px solid var(--separator);
        }

        .video-header h2 {
            margin: 0;
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            overflow: hidden;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        video {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .debug-panel {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin: var(--spacing-lg) 0;
            border: 1px solid var(--separator);
        }

        .debug-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
            letter-spacing: -0.01em;
        }

        .debug-content {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
            background: var(--bg-secondary);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            border: 1px solid var(--separator);
        }

        /* Prompt Panel */
        .prompt-panel {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin: var(--spacing-lg) 0;
            border: 1px solid var(--separator);
        }

        .prompt-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
            letter-spacing: -0.01em;
        }

        .prompt-content .emotion-tag {
            display: inline-block;
            background: var(--accent-blue);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-sm);
        }

        .prompt-content .prompt-preview {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin: 0;
            font-style: italic;
        }

        .tips-card {
            background: rgba(59, 130, 246, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
            border: 1px solid var(--glass-border);
            border-left: 4px solid var(--apple-blue);
            box-shadow: var(--shadow-glass);
        }

        .tips-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--apple-blue);
            margin: 0 0 var(--spacing-sm) 0;
        }

        .tips-content {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* AI Art Overlay Styles */
        .ai-art-overlay {
            position: absolute;
            bottom: var(--spacing-md);
            right: var(--spacing-md);
            width: 300px;
            max-width: 40%;
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-glass);
            border: 1px solid var(--glass-border);
            z-index: 10;
        }

        .ai-art-overlay .ai-art-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .ai-art-overlay .ai-art-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0;
            letter-spacing: -0.01em;
        }

        .ai-art-overlay .ai-art-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            background: var(--accent-purple);
            color: white;
            padding: 3px 6px;
            border-radius: var(--radius-sm);
            font-size: 0.65rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ai-art-overlay .ai-art-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-sm);
            box-shadow: var(--shadow-glass);
        }

        .ai-art-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-lg);
            transition: opacity 0.3s ease;
        }

        .ai-art-overlay .ai-art-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: var(--spacing-md);
        }

        .ai-art-overlay .ai-art-placeholder .title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-xs) 0;
        }

        .ai-art-overlay .ai-art-placeholder .description {
            font-size: 0.75rem;
            line-height: 1.4;
            margin: 0;
        }

        .ai-art-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
        }

        .ai-art-loading .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--text-tertiary);
            border-top: 3px solid var(--apple-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-sm);
        }

        .ai-art-loading .text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .ai-art-info {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-glass);
        }

        .ai-art-info .emotion-tag {
            display: inline-block;
            background: var(--apple-blue);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-sm);
        }

        .ai-art-info .prompt-preview {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin: 0;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-lg);
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            text-decoration: none;
            min-width: 140px;
            letter-spacing: -0.01em;
            box-shadow: var(--shadow-glass);
            border: 1px solid transparent;
        }

        .btn-primary:hover {
            background: var(--apple-blue-dark);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: var(--spacing-xxxl);
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-glass-lg);
            border: 1px solid var(--glass-border);
            text-align: center;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--text-tertiary);
            border-top: 3px solid var(--apple-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-lg);
        }

        .loading-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
            letter-spacing: -0.01em;
        }

        .loading-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin: 0;
            font-weight: 400;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-card {
            background: rgba(239, 68, 68, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-left: 4px solid var(--apple-red);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
            box-shadow: var(--shadow-glass);
        }

        .error-title {
            color: var(--apple-red);
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 var(--spacing-sm) 0;
        }

        .error-message {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin: 0;
            line-height: 1.5;
        }

        .privacy-note {
            background: rgba(16, 185, 129, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin: var(--spacing-xl) var(--spacing-xl);
            text-align: center;
            border: 1px solid rgba(16, 185, 129, 0.3);
            box-shadow: var(--shadow-glass);
        }

        .error-card {
            margin: var(--spacing-lg) var(--spacing-xl);
        }

        .privacy-note .icon {
            font-size: 1.5rem;
            margin-bottom: var(--spacing-sm);
        }

        .privacy-note .title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-xs) 0;
        }

        .privacy-note .description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        .footer {
            text-align: center;
            padding: var(--spacing-xxl) var(--spacing-xl);
            margin-top: var(--spacing-xxxl);
            border-top: 1px solid var(--separator);
            width: 100%;
        }

        .footer-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
        }

        .footer-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
                padding: var(--spacing-md);
            }

            .info-column {
                order: 2;
            }

            .content-column {
                order: 1;
            }

            .ai-art-overlay {
                width: 250px;
                max-width: 35%;
            }
        }

        @media (max-width: 768px) {
            .main-grid {
                padding: var(--spacing-sm);
                gap: var(--spacing-sm);
            }

            .panel-header {
                margin-bottom: var(--spacing-md);
                padding-bottom: var(--spacing-sm);
            }

            .ai-art-overlay {
                width: 200px;
                max-width: 45%;
                bottom: var(--spacing-sm);
                right: var(--spacing-sm);
            }
        }

        @media (max-width: 768px) {
            .hero-section {
                padding: var(--spacing-xl) var(--spacing-md);
            }

            .main-grid {
                padding: var(--spacing-md);
            }

            .privacy-note {
                margin: var(--spacing-xl) var(--spacing-md);
            }

            .error-card {
                margin: var(--spacing-lg) var(--spacing-md);
            }

            .footer {
                padding: var(--spacing-xxl) var(--spacing-md);
            }

            .hero-section h1 {
                font-size: 2.5rem;
            }

            .emoji {
                font-size: 4.5rem;
            }

            .status-text {
                font-size: 1.5rem;
            }

            .btn-primary {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .hero-section {
                padding: var(--spacing-lg) var(--spacing-sm);
            }

            .main-grid {
                padding: var(--spacing-sm);
            }

            .privacy-note {
                margin: var(--spacing-lg) var(--spacing-sm);
            }

            .error-card {
                margin: var(--spacing-md) var(--spacing-sm);
            }

            .footer {
                padding: var(--spacing-xl) var(--spacing-sm);
            }

            .hero-section h1 {
                font-size: 2rem;
            }

            .emoji {
                font-size: 3.5rem;
            }

            .emotion-panel,
            .video-section {
                padding: var(--spacing-lg);
            }
        }

        /* Large screen optimization */
        @media (min-width: 1600px) {
            .main-grid {
                grid-template-columns: 1fr 2fr;
                padding: var(--spacing-xxl) var(--spacing-xxxl);
                gap: var(--spacing-xxl);
            }

            .hero-section {
                padding: var(--spacing-xxxl) var(--spacing-xxxl) var(--spacing-xxl);
            }

            .privacy-note {
                margin: var(--spacing-xl) var(--spacing-xxxl);
            }

            .error-card {
                margin: var(--spacing-lg) var(--spacing-xxxl);
            }

            .footer {
                padding: var(--spacing-xxl) var(--spacing-xxxl);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">


        <!-- Loading State -->
        <div id="loading" class="loading-container">
            <div class="loading-spinner"></div>
            <h2 class="loading-title">Loading AI Models</h2>
            <p class="loading-subtitle" id="progress">Initializing neural networks...</p>
        </div>

        <!-- Main Application -->
        <div id="main-content" style="display: none;">
            <div class="main-grid">
                <!-- Left Column: Info Panel (33%) -->
                <div class="info-column">
                    <!-- Emotion Display Panel -->
                    <div class="emotion-panel">
                        <div class="panel-header">
                            <h1>Facial Emotion Detector</h1>
                            <p class="subtitle">Experience the future of AI-powered emotion recognition with real-time analysis using your camera</p>
                        </div>

                        <div class="live-indicator">
                            <div class="live-dot"></div>
                            Live Detection
                        </div>

                        <div class="emoji-display">
                            <div class="emoji" id="emoji">üòê</div>
                            <div class="status-text">You look <span id="emotion-text">neutral</span></div>
                            <p class="status-subtitle">AI is analyzing your facial expressions in real-time</p>
                        </div>

                        <!-- Debug Panel -->
                        <div class="debug-panel">
                            <div class="debug-title">Emotion Analysis</div>
                            <div class="debug-content">
                                <div id="emotion-values">Waiting for face detection...</div>
                            </div>
                        </div>

                        <!-- AI Prompt Preview -->
                        <div class="prompt-panel" id="prompt-panel">
                            <div class="prompt-title">AI Art Prompt</div>
                            <div class="prompt-content">
                                <div class="emotion-tag" id="current-emotion-tag">Neutral</div>
                                <p class="prompt-preview" id="prompt-preview">Waiting for emotion detection...</p>
                            </div>
                        </div>

                        <!-- Tips Card -->
                        <div class="tips-card">
                            <div class="tips-title">Tips for Best Results</div>
                            <div class="tips-content">
                                Make exaggerated expressions and hold them for 2-3 seconds:<br>
                                üòÄ Big smile ‚Ä¢ üò¢ Deep frown ‚Ä¢ üò† Furrow brow ‚Ä¢ üò≤ Open mouth wide
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Camera Feed (66%) -->
                <div class="content-column">
                    <!-- Video Section -->
                    <div class="video-section">
                        <div class="video-header">
                            <h2>Live Camera Feed</h2>
                        </div>

                        <div class="video-container">
                            <video id="video" width="640" height="480" autoplay muted playsinline></video>
                            <canvas id="canvas"></canvas>

                            <!-- AI Art Panel - Overlaid in bottom right -->
                            <div class="ai-art-overlay">
                                <div class="ai-art-header">
                                    <h3 class="ai-art-title">AI Art Generation</h3>
                                    <div class="ai-art-indicator" id="ai-status">
                                        <div class="live-dot"></div>
                                        Ready
                                    </div>
                                </div>

                                <div class="ai-art-container" id="ai-art-container">
                                    <div class="ai-art-placeholder" id="ai-placeholder">
                                        <div class="title">Emotion-Based Art</div>
                                        <p class="description">AI will generate beautiful artwork based on your detected emotions. Start the camera to begin!</p>
                                    </div>
                                    <img id="ai-art-image" class="ai-art-image" style="display: none;" alt="AI Generated Art">
                                    <div class="ai-art-loading" id="ai-loading" style="display: none;">
                                        <div class="spinner"></div>
                                        <div class="text">Generating art...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="padding: var(--spacing-lg); text-align: center;">
                            <button id="start-camera" class="btn-primary" onclick="startCamera()">
                                üì∑ Start Camera
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Display -->
            <div id="error" class="error-card" style="display: none;">
                <div class="error-title">Something went wrong</div>
                <div class="error-message" id="error-message"></div>
            </div>

            <!-- Privacy Note -->
            <div class="privacy-note">
                <div class="icon">üîí</div>
                <div class="title">Privacy First</div>
                <p class="description">Your video never leaves your device. All AI processing happens locally in your browser for complete privacy and security.</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-title">Built with Face-API.js and TensorFlow.js</div>
            <p class="footer-description">Detects seven emotions: Happy, Sad, Angry, Fearful, Disgusted, Surprised, and Neutral</p>
        </div>
    </div>

    <script>
        const statusIcons = {
            default: { emoji: 'üòê', name: 'neutral' },
            neutral: { emoji: 'üòê', name: 'neutral' },
            happy: { emoji: 'üòÄ', name: 'happy' },
            sad: { emoji: 'üò•', name: 'sad' },
            angry: { emoji: 'üò†', name: 'angry' },
            fearful: { emoji: 'üò®', name: 'fearful' },
            disgusted: { emoji: 'ü§¢', name: 'disgusted' },
            surprised: { emoji: 'üò≤', name: 'surprised' },
        };

        let modelsLoaded = false;
        let detectionInterval = null;
        let currentEmotion = 'neutral';
        let emotionHistory = [];
        let lastUpdateTime = Date.now();

        // AI Art Generation variables
        let isGeneratingArt = false;
        let lastGeneratedEmotion = null;
        // Auto-detect API URL based on environment
        let apiBaseUrl = window.location.hostname === 'localhost' ?
            'http://localhost:3001/api' :
            `${window.location.origin}/api`; // Uses Vercel serverless functions
        let generationCooldown = 5000; // 5 seconds between generations

        // Prompt tracking for each emotion
        let usedPrompts = {
            happy: [],
            neutral: [],
            sad: [],
            angry: [],
            fearful: [],
            disgusted: [],
            surprised: []
        };

        // Emotion-specific prompts (20 per emotion)
        const emotionPrompts = {
            happy: [
                "Joyful humanoid robot standing in a sunlit flower field ‚Äî white glossy armor gleaming in the sunlight ‚Äî one hand mid-wave with soft motion blur ‚Äî surrounded by wildflowers in bloom ‚Äî bright blue sky with fluffy clouds ‚Äî warm and optimistic tone ‚Äî 16:9",
                "Smiling robot with glowing eyes and rounded features ‚Äî skipping through a field of daisies, motion blur on one foot ‚Äî golden-hour lighting ‚Äî sun rays filtering through petals ‚Äî playful and serene future-nature fusion ‚Äî 16:9",
                "Happy robot with curved chrome limbs dancing gently in a meadow of sunflowers ‚Äî subtle motion blur on arms ‚Äî butterflies fluttering in the background ‚Äî cinematic soft-focus lens ‚Äî pastel tones and peaceful mood ‚Äî 16:9",
                "Friendly robot with a ceramic finish and gold details, sitting in a patch of poppies ‚Äî head tilted slightly with expressive glow ‚Äî hand raised in a blurred gesture of joy ‚Äî colorful floral field stretching into the distance ‚Äî ambient golden lighting ‚Äî 16:9",
                "Single humanoid robot spinning playfully in a field of lavender ‚Äî arms extended, motion blur showing movement ‚Äî warm breeze, flowers swaying ‚Äî bright, dreamy sky above ‚Äî joyful organic-mechanical harmony ‚Äî 16:9",
                "White-armored robot with floral crown, walking slowly through tall wildflowers ‚Äî slight motion blur in limbs ‚Äî vibrant colors, butterflies, birds in the background ‚Äî soft cinematic sunlight and nature's harmony ‚Äî 16:9",
                "Expressive robot kneeling in a flower field, inspecting a single glowing bloom ‚Äî one arm blurred from reaching out ‚Äî colorful meadow under radiant afternoon light ‚Äî tranquil, gentle futuristic vision ‚Äî 16:9",
                "Cheerful robot with an LED faceplate showing smiling eyes ‚Äî running joyfully through tulips, motion blur behind ‚Äî trails of petals caught mid-air ‚Äî lush, bright, immersive landscape ‚Äî 16:9",
                "Solo robot with a mirrored visor reflecting fields of flowers ‚Äî mid-jump with light motion blur ‚Äî vibrant spring palette, rolling hills of blossoms in the background ‚Äî playful and poetic AI in nature ‚Äî 16:9",
                "Warmly lit robot with golden joints lying in a field of mixed wildflowers ‚Äî arm raised with motion blur, waving at the sky ‚Äî serene floral horizon ‚Äî peaceful, childlike wonder meets future tech ‚Äî 16:9",
                "Delighted humanoid robot twirling gently in a vast field of yellow buttercups ‚Äî arms outstretched with trailing motion blur ‚Äî sunset glow wrapping the landscape ‚Äî petals drifting in mid-air ‚Äî joyful and poetic scene ‚Äî 16:9",
                "Happy robot with soft-rounded features walking barefoot-style through tall grass and wildflowers ‚Äî hand brushing the blossoms with light motion blur ‚Äî glowing forest edge in the distance ‚Äî uplifting and cinematic ‚Äî 16:9",
                "Cheerful robot with blue-tinted visor sitting under a blossoming tree in a flower field ‚Äî waving with a slightly blurred arm ‚Äî sunlight sparkling through leaves ‚Äî peaceful, heartwarming scene ‚Äî 16:9",
                "Robot with heart-shaped LED display bouncing lightly in a pink flower meadow ‚Äî motion blur on lower limbs and falling blossoms ‚Äî soft clouds above, lens flare glints ‚Äî playful nature-tech harmony ‚Äî 16:9",
                "Smiling AI figure skipping through rows of orange marigolds ‚Äî blurred motion in raised knee and outstretched hand ‚Äî radiant golden-hour sun casting long shadows ‚Äî bright and spirited ‚Äî 16:9",
                "Curious robot surrounded by blooming cosmos flowers ‚Äî gently spinning in place with motion-blurred arms ‚Äî sun-dappled field with insects and light breeze ‚Äî vibrant and serene mood ‚Äî 16:9",
                "Playful robot holding a bouquet of wildflowers, caught mid-jump ‚Äî trailing motion blur behind legs ‚Äî lush countryside horizon ‚Äî cheerful, youthful energy ‚Äî sunlit and cinematic ‚Äî 16:9",
                "Robot with metallic freckles and expressive eyes lying on its back in a violet flower field ‚Äî slowly raising one hand with blur trail ‚Äî dreamy sky with birds flying above ‚Äî tranquil joy ‚Äî 16:9",
                "Dancing robot in a daisy-covered clearing ‚Äî motion blur on hips and feet to suggest rhythm ‚Äî nature surrounds with soft fog at sunrise ‚Äî harmonic fusion of innocence and tech ‚Äî 16:9",
                "Happy robot gently tossing flower petals into the air ‚Äî soft motion blur as petals float and arms move ‚Äî surrounded by lush blooms, clear sky, and glowing morning light ‚Äî whimsical and cinematic ‚Äî 16:9"
            ],
            neutral: [
                "Single humanoid robot in glossy white armor with gold neck accents ‚Äî subtle motion blur in one extended arm ‚Äî cinematic spotlight from above ‚Äî black background with minimal reflections ‚Äî futuristic, clean design ‚Äî 16:9",
                "One sleek robot with reflective obsidian visor and asymmetrical shoulder plating ‚Äî arm slightly blurred mid-gesture ‚Äî foggy sci-fi backdrop with rim light ‚Äî ultra-polished surfaces ‚Äî moody cinematic feel ‚Äî 16:9",
                "Futuristic robot with dark chrome chest panel and matte helmet ‚Äî turning slightly, with motion blur trailing behind ‚Äî strong key light from upper left ‚Äî background fading into soft tech shadows ‚Äî 16:9",
                "Solitary robot with exposed joint mechanics and illuminated torso ‚Äî walking forward with legs in motion blur ‚Äî ambient glow and scattered particles ‚Äî high realism and sci-fi depth ‚Äî 16:9",
                "Front-facing humanoid robot with narrow facial plate and fine surface scratches ‚Äî motion blur around shoulder as if just moved ‚Äî soft industrial lighting ‚Äî isolated tech stage ‚Äî 16:9",
                "Single robot with gold-trimmed helmet and layered chest plating ‚Äî half body caught in motion blur suggesting a swift turn ‚Äî glossy floor reflections ‚Äî deep space ambiance ‚Äî 16:9",
                "Robot in high-gloss ceramic armor with segmented limbs ‚Äî light motion blur on one side, simulating shift in stance ‚Äî focused spotlight beam ‚Äî tech cave background ‚Äî cinematic vibe ‚Äî 16:9",
                "Lone AI sentinel with monochrome design, intricate spine structure visible ‚Äî motion blur from rising arm ‚Äî dramatic low angle view ‚Äî dust particles in ambient backlight ‚Äî 16:9",
                "Humanoid robot in matte white finish with asymmetric visor design ‚Äî slight motion blur across lower body, mid-step ‚Äî soft gradient background with tech haze ‚Äî elegant sci-fi aesthetic ‚Äî 16:9",
                "Heroic robot in bold stance, front-lit with subtle warm tones ‚Äî head tilt causing slight blur effect ‚Äî high-detail joints and chest plating ‚Äî isolated on dark moody backdrop ‚Äî 16:9",
                "Minimalist humanoid robot in brushed steel finish ‚Äî one arm extended, fingertips slightly motion blurred ‚Äî soft spotlight illuminating reflective surfaces ‚Äî dark void background with subtle tech glows ‚Äî 16:9",
                "Single robot with matte black exoskeleton and luminous core ‚Äî torso twist creating a gentle motion blur ‚Äî floating ambient particles ‚Äî low ambient light with directional top lighting ‚Äî sci-fi tech noir style ‚Äî 16:9",
                "Futuristic android with geometric plating and no visible face ‚Äî motion blur around knees as if shifting weight ‚Äî background of smoky volumetric light beams ‚Äî crisp edge lighting and atmospheric depth ‚Äî 16:9",
                "Single AI unit with modular chest design and amber accent lights ‚Äî captured mid-step with blurred foot trailing ‚Äî metallic industrial setting with haze and reflections ‚Äî moody futuristic minimalism ‚Äî 16:9",
                "Angular robot design with sculpted armor plates and vented shoulder joints ‚Äî left arm blurred while raising ‚Äî background of subtle backlight silhouettes ‚Äî stark, minimal color palette ‚Äî 16:9",
                "Solitary bipedal robot with sharp jawline and brushed titanium finish ‚Äî turning head with motion blur sweep ‚Äî dark environment with only floor reflections and narrow beam illumination ‚Äî quiet, precise energy ‚Äî 16:9",
                "Robot with a neutral posture, mid-walk in low gravity ‚Äî soft motion blur across hips and hands ‚Äî dimly lit corridor with glowing data lines ‚Äî quiet anticipation and weightless futurism ‚Äî 16:9",
                "Clean humanoid robot with segmented plating and internal light veins ‚Äî motion blur around wrist as it rotates ‚Äî studio-lit with a cold color temperature ‚Äî black background with faint lens flares ‚Äî 16:9",
                "Neutral stance robot with hexagonal limb details and a non-reflective matte surface ‚Äî barely visible motion blur in subtle micro-adjustment pose ‚Äî volumetric light shafts cutting through darkness ‚Äî minimalistic elegance ‚Äî 16:9",
                "AI unit with wide shoulder frame and illuminated helmet visor ‚Äî captured just after a pivot turn with blurred limb edges ‚Äî crisp lighting from the left ‚Äî cold, atmospheric backdrop with engineered serenity ‚Äî 16:9"
            ],
            sad: [
                "Lonely humanoid robot in matte grey armor, standing motionless in heavy rain ‚Äî droplets trailing down smooth plating ‚Äî blue hour lighting ‚Äî soft motion blur in falling rain ‚Äî moody urban background ‚Äî 16:9",
                "Sad robot with dimly lit visor, shoulders slumped ‚Äî cold rain pouring over a reflective chest plate ‚Äî dark alley with neon reflections on wet ground ‚Äî emotional silence ‚Äî 16:9",
                "Single robot in a long raincoat-style exterior shell ‚Äî slow motion blur as rain slides off ‚Äî surrounded by puddles in a dystopian street ‚Äî blue-purple color grading ‚Äî 16:9",
                "Broken-looking robot under a flickering streetlamp in the rain ‚Äî water pooling at its feet ‚Äî soft motion blur from distant cars ‚Äî rainy cityscape backdrop ‚Äî deep, cinematic sadness ‚Äî 16:9",
                "Weathered humanoid robot standing still in a stormy field ‚Äî rivulets of rain cascading down its faceplate ‚Äî arms loose by its side ‚Äî grayscale scene with faint warm backlight ‚Äî 16:9",
                "Melancholy robot looking downward, motion blur in streaming rain around ‚Äî reflective armor dulled by water ‚Äî soft spotlight overhead ‚Äî muted reflections in puddles ‚Äî 16:9",
                "Single robot under a collapsed structure in the rain ‚Äî flickering internal lights ‚Äî streaks of rain catching environmental light ‚Äî sadness in stillness ‚Äî worn-down futuristic vibe ‚Äî 16:9",
                "Chrome-faced robot turned slightly away, rain streaming across reflective surface ‚Äî overcast lighting ‚Äî long shadows and light motion blur in raindrops ‚Äî atmosphere heavy with isolation ‚Äî 16:9",
                "Abandoned service robot standing at the edge of a flooded sidewalk ‚Äî one leg partially submerged ‚Äî motion blur in slanted rain ‚Äî neon sign flickering in background ‚Äî 16:9",
                "Silent sentinel-style robot, arms crossed, standing beneath a broken shelter ‚Äî rain dripping from helmet ‚Äî moody contrast lighting ‚Äî cinematic sci-fi noir ‚Äî 16:9",
                "Sad robot standing alone on a rooftop in the rain ‚Äî motion blur in wind-blown droplets ‚Äî expressionless visor tilted down ‚Äî minimal lighting and blurred skyline ‚Äî 16:9",
                "Single robot framed in a rainy, overgrown landscape ‚Äî moss-covered joints ‚Äî standing still as raindrops blur in the foreground ‚Äî post-apocalyptic sorrow ‚Äî 16:9",
                "Robot with glowing blue chest light dimmed ‚Äî kneeling in the rain with hands resting on thighs ‚Äî streaks of water obscuring body lines ‚Äî sorrowful and resigned tone ‚Äî 16:9",
                "Old-generation robot slowly rusting in the rain ‚Äî motion blur on water streams ‚Äî solitary placement in middle of empty road ‚Äî dim ambient glow from foggy lights ‚Äî 16:9",
                "Futuristic android leaning against a wall in heavy rain ‚Äî wet surface reflections all around ‚Äî blurred cars in background ‚Äî eyes turned off ‚Äî sense of loss ‚Äî 16:9",
                "Slender robot standing with arms by its side on a rain-drenched bridge ‚Äî motion blur on falling rain and distant vehicles ‚Äî dramatic key light from behind ‚Äî cold sadness ‚Äî 16:9",
                "Robot alone at an abandoned train platform ‚Äî flickering screen light on wet plating ‚Äî rain blurring the scene in long streaks ‚Äî faded signage behind ‚Äî 16:9",
                "Humanoid robot with cracked faceplate under heavy rain ‚Äî head lowered ‚Äî backlight silhouettes through mist ‚Äî glistening water trails ‚Äî silent sorrow ‚Äî 16:9",
                "Damaged robot holding a wilted flower in the rain ‚Äî petals falling in motion blur ‚Äî puddle reflections mirror lonely stance ‚Äî late-night lighting ‚Äî 16:9",
                "Solitary robot in a storm, lightning briefly illuminating figure ‚Äî heavy rain obscuring lower body ‚Äî emotion in frozen pose ‚Äî deep blue and grey palette ‚Äî 16:9"
            ],
            angry: [
                "Angry humanoid robot with glowing red eyes and clenched fists ‚Äî sparks flying from shoulder joints ‚Äî dark industrial tunnel with flickering lights ‚Äî high tension and motion blur in steam bursts ‚Äî 16:9",
                "Single combat robot mid-roar with jaw open and red-lit eyes glowing fiercely ‚Äî power surges arcing from arms ‚Äî scorched battlefield background ‚Äî cinematic dust and fire haze ‚Äî 16:9",
                "Furious robot with red glowing eyes partially covered by cracked helmet ‚Äî arm raised with motion blur mid-strike ‚Äî burning debris in background ‚Äî heavy metal textures and aggression ‚Äî 16:9",
                "Battle-worn robot with clawed hands and molten chest core ‚Äî standing in a field of crushed metal ‚Äî eyes blazing red ‚Äî smoke rising from vents ‚Äî dark future war tone ‚Äî 16:9",
                "Single red-eyed robot surrounded by shattered screens ‚Äî motion blur as it slams fist into ground ‚Äî sparks and electrical arcs exploding outward ‚Äî intense spotlight contrast ‚Äî 16:9",
                "Enraged AI sentinel with glowing red optics and extended blade arm ‚Äî caught mid-swing in motion blur ‚Äî alarms flashing in background ‚Äî hostile industrial bunker ‚Äî 16:9",
                "Rage-filled robot tearing through a wall ‚Äî red eyes glowing violently ‚Äî debris mid-air with strong motion trails ‚Äî backlit by warning strobes ‚Äî cinematic destruction ‚Äî 16:9",
                "Robotic warrior with smoke venting from its back ‚Äî fists clenched and red eyes focused forward ‚Äî stormy sky with thunder flashes ‚Äî standing in crater ‚Äî aggressive stance ‚Äî 16:9",
                "Single furious robot screaming into the void ‚Äî face twisted in mechanical tension ‚Äî motion blur on shaking limbs ‚Äî molten metal sparks raining down ‚Äî fire-lit shadows ‚Äî 16:9",
                "High-tech soldier robot with cracked armor ‚Äî red glow from eye sockets pulsing with intensity ‚Äî weaponized limbs charging with energy ‚Äî scorched earth setting ‚Äî 16:9",
                "Malfunctioning robot with red eyes flickering chaotically ‚Äî surrounded by broken drone corpses ‚Äî twitching with motion blur ‚Äî corrupted system overload aura ‚Äî 16:9",
                "One furious robot mid-leap, red eyes glowing like lasers ‚Äî motion blur on legs and arms ‚Äî dramatic red-orange explosion behind ‚Äî battle-ravaged urban backdrop ‚Äî 16:9",
                "Raging robot with red eyes and fractured chassis ‚Äî standing under stormlight, gripping a crushed helmet ‚Äî angry sparks flickering ‚Äî industrial rebellion theme ‚Äî 16:9",
                "Robot surrounded by shattered holograms and destroyed screens ‚Äî blazing red eyes and angry chest pulses ‚Äî body trembling with motion blur ‚Äî electric tension in the air ‚Äî 16:9",
                "Humanoid robot roaring skyward, red visor split open with internal glow ‚Äî smoke columns rising ‚Äî crushed weapon in hand ‚Äî war-torn sci-fi landscape ‚Äî 16:9",
                "Furious red-eyed robot dragging itself out of rubble ‚Äî half body scorched ‚Äî lightning sparking from joints ‚Äî blood-red ambient lighting ‚Äî wrathful and relentless ‚Äî 16:9",
                "Single robot staring directly into camera with glowing red eyes ‚Äî flames reflected in chrome armor ‚Äî mechanical fists clenched ‚Äî subtle motion blur in pulsing core ‚Äî 16:9",
                "Rage mode engaged: robot with hydraulic limbs and glowing red veins ‚Äî sprinting forward with motion blur ‚Äî background on fire ‚Äî alarm lights flashing ‚Äî 16:9",
                "Red-eyed robot smashing through reinforced glass ‚Äî shards caught in motion blur ‚Äî internal furnace glowing ‚Äî tech lab in chaos ‚Äî cinematic rage explosion ‚Äî 16:9",
                "One angry robot atop a pile of broken drones ‚Äî thunderstorm overhead ‚Äî red eyes glowing through rain ‚Äî electricity crackling off limbs ‚Äî total vengeance energy ‚Äî 16:9"
            ],
            surprised: [
                "Surprised humanoid robot with wide-open glowing eyes ‚Äî head tilted back slightly ‚Äî standing in a glowing cave filled with bioluminescent tech flora ‚Äî faint motion blur around fingers in reaction ‚Äî 16:9",
                "Single robot recoiling in shock, red sensor flickering into alert mode ‚Äî motion blur in arms pulled back ‚Äî massive unknown structure revealed in fog ‚Äî awe meets fear ‚Äî 16:9",
                "Futuristic android with translucent plating ‚Äî facial screen showing \"!\" symbol ‚Äî caught mid-step with one foot blurred ‚Äî alien object levitating before it ‚Äî soft light glow and mystery ‚Äî 16:9",
                "Surprised robot in a lab, surrounded by hovering holograms ‚Äî arms slightly lifted with blur from fast reaction ‚Äî data overload streaming across its visor ‚Äî cinematic, glitching light trails ‚Äî 16:9",
                "Robot with expressive eyes glowing wide ‚Äî standing on cliff edge overlooking a massive futuristic city rising from clouds ‚Äî hands slightly blurred in frozen awe ‚Äî sunset horizon ‚Äî 16:9",
                "Single robot turning sharply with surprised posture ‚Äî head slightly tilted, shoulder blurred ‚Äî behind it, a portal glowing open ‚Äî mist, chaos, and uncertainty ‚Äî 16:9",
                "Surprised service robot in a clean white hallway ‚Äî object floats mid-air, casting glowing light on its face ‚Äî subtle motion blur in fingers reaching out ‚Äî sterile, sleek sci-fi space ‚Äî 16:9",
                "Small humanoid robot in a marketplace ‚Äî glowing red balloon unexpectedly floating in front of its face ‚Äî mechanical eyes widened ‚Äî motion blur from backward step ‚Äî surreal and curious ‚Äî 16:9",
                "Surprised battle droid emerging into sunlight after years in darkness ‚Äî overwhelmed by the world beyond ‚Äî eyes glowing brighter ‚Äî subtle body tremble and atmospheric dust ‚Äî 16:9",
                "Robot discovering an old human artifact ‚Äî emotion displayed through eye glow pulsing ‚Äî motion blur from shifting arms ‚Äî cinematic light shaft falling on object ‚Äî quiet awe ‚Äî 16:9",
                "Surprised robot caught in spotlight during stealth mission ‚Äî eyes wide in glowing white ‚Äî background lights activating ‚Äî slight motion blur as it flinches ‚Äî tension and alert ‚Äî 16:9",
                "Futuristic robot on a bridge suddenly lit up by an approaching unidentified aircraft ‚Äî glow reflecting on chrome face ‚Äî moment of shock frozen in body pose ‚Äî 16:9",
                "Robot in misty forest stumbles upon its own clone ‚Äî eyes blinking in red and blue glow ‚Äî stepping back with motion blur ‚Äî soft fog, emotional uncertainty ‚Äî 16:9",
                "One robot mid-jump reacting to ground collapsing beneath ‚Äî hands lifted with blurred trails ‚Äî eyes widened in glowing red panic ‚Äî collapsing tech environment ‚Äî 16:9",
                "Single robot in deep space station reacting to unexpected hologram ‚Äî visual distortion effects in background ‚Äî hands slowly raising in motion blur ‚Äî neon-lit interior ‚Äî 16:9",
                "Surprised robot looking into mirror for first time ‚Äî screen face cycling rapidly ‚Äî glitch flicker on chrome ‚Äî motion blur on shoulders ‚Äî discovery and confusion ‚Äî 16:9",
                "Exploration robot uncovering ancient AI monolith ‚Äî red glow from artifact casting surprised light on its face ‚Äî motion blur as it leans back ‚Äî cinematic desert setting ‚Äî 16:9",
                "Single robot in spaceship cockpit reacting to malfunction alert ‚Äî red warning lights flashing ‚Äî hands frozen on controls, blurred from sudden tension ‚Äî cinematic cockpit shadows ‚Äî 16:9",
                "Surprised robot in jungle ruins, surrounded by glowing alien glyphs ‚Äî camera angle from below, eyes wide ‚Äî falling leaves and floating particles in slow motion ‚Äî discovery and reverence ‚Äî 16:9",
                "Futuristic humanoid robot looking up in awe as a massive sky object slowly descends ‚Äî red light cast over its reflective face ‚Äî subtle motion blur in rising arm ‚Äî tone of wonder and fear ‚Äî 16:9"
            ],
            fearful: [
                "Terrified humanoid robot crouched behind debris, red eyes wide and flickering ‚Äî subtle tremble blur in hands ‚Äî giant shadow looming over in fog ‚Äî hard side lighting and ambient dread ‚Äî 16:9",
                "Robot frozen mid-step, staring into darkness with glowing white eyes turned red from terror ‚Äî shaking arms in motion blur ‚Äî flickering corridor lights and heavy smoke ‚Äî absolute tension ‚Äî 16:9",
                "Panicked robot running through a narrow tunnel, limbs blurred from frantic movement ‚Äî red emergency lighting ‚Äî camera tilt adds unease ‚Äî distant monstrous form barely visible ‚Äî 16:9",
                "Fear-stricken robot in a crumbling lab, shielding its face ‚Äî body arched backward in terror ‚Äî glass and sparks flying past in motion blur ‚Äî high danger cinematic moment ‚Äî 16:9",
                "Single robot on its knees, looking up with glowing red pupils trembling ‚Äî arms slightly raised in pleading stance ‚Äî behind it, a destructive force of light ‚Äî pure existential dread ‚Äî 16:9",
                "Robot hiding in the shadows of a broken ship ‚Äî face turned toward flashing red warning beacons ‚Äî eyes glowing with fear ‚Äî motion blur in shallow breathing movements ‚Äî isolation and horror ‚Äî 16:9",
                "Paralyzed android standing in water, reflection warped ‚Äî wide red eyes flickering erratically ‚Äî unknown creature's silhouette approaching ‚Äî heavy rain and slow-motion atmosphere ‚Äî 16:9",
                "Frightened robot in stasis corridor, backing away ‚Äî foot dragged in motion blur ‚Äî sharp top-down light casting long threatening shadows ‚Äî eerie silence, sheer panic ‚Äî 16:9",
                "Robot cornered in a ruined facility ‚Äî eyes flickering between blue and red in terror ‚Äî wall behind cracked, something trying to break through ‚Äî subtle vibration blur ‚Äî 16:9",
                "One robot in fetal position, arms wrapped around head ‚Äî glitching vision effect in background ‚Äî flashing red lights and haunting echoes ‚Äî pure mechanical fear ‚Äî 16:9",
                "Single robot staring at its own dismembered arm on the ground ‚Äî breathing vents fluttering with panic ‚Äî red glow rising around ‚Äî slow realization of destruction ‚Äî 16:9",
                "Fearful humanoid robot hiding behind semi-transparent screen ‚Äî monstrous silhouette walking by ‚Äî internal eye glow surging in pulses ‚Äî motion blur from shaky limbs ‚Äî 16:9",
                "Robot in a ruined chamber holding a broken relic ‚Äî realization dawning in wide flickering eyes ‚Äî soft blue ambient light turning red ‚Äî long shadow falling across its face ‚Äî 16:9",
                "Terrified robot clutching a wall as environment collapses ‚Äî eyes scanning frantically ‚Äî motion blur in breath and fingers ‚Äî alarms flashing ‚Äî total desperation ‚Äî 16:9",
                "AI unit in panic mode, system HUD overload ‚Äî screen face flickering static with wide eyes ‚Äî blurred hand trying to swipe alerts away ‚Äî enclosed cockpit bursting with tension ‚Äî 16:9",
                "Frightened robot dragging itself backward on the ground ‚Äî overhead threat approaching ‚Äî red searchlight sweeping over ‚Äî oil smears and motion blur trail ‚Äî survival instinct triggered ‚Äî 16:9",
                "One trembling robot gripping its own arm, glitching sparks coming from joints ‚Äî red glowing eyes dimming ‚Äî haunting silence surrounding ‚Äî loss, fear, malfunction ‚Äî 16:9",
                "Robot backed against a wall, rain pouring ‚Äî red laser sight dots blinking on its chest ‚Äî full-body motion blur in panic ‚Äî emotional freeze-frame ‚Äî 16:9",
                "Fear-saturated android mid-sprint through abandoned train platform ‚Äî full-body blur ‚Äî red glow of train in distance feels like doom ‚Äî wind, sound, and velocity ‚Äî 16:9",
                "Frozen robot staring directly into camera, eyes flickering wildly ‚Äî entire background burning or collapsing ‚Äî blur from minor spasms ‚Äî helpless, haunted, and afraid ‚Äî 16:9"
            ],
            disgusted: [
                "Disgusted humanoid robot pulling its head back, hand raised in rejection ‚Äî flickering red and green reflections on faceplate ‚Äî leaking organic matter on the floor ‚Äî motion blur on fingers ‚Äî sterile lab setting ‚Äî 16:9",
                "Single robot turning away from decomposing biotech mass ‚Äî torso twisted in motion blur ‚Äî face screen glitching in revulsion ‚Äî noxious green mist in background ‚Äî industrial decay ‚Äî 16:9",
                "Android stepping back from a broken synthetic organ ‚Äî expression panel flickering with disgust emojis ‚Äî red eye glow dimmed ‚Äî motion blur in backward movement ‚Äî flickering overhead lights ‚Äî 16:9",
                "Robot in pristine white armor covered in splattered biological sludge ‚Äî hand raised, shaking in blurred motion ‚Äî twisted steel and wires hanging from ceiling ‚Äî deep discomfort in posture ‚Äî 16:9",
                "Disgusted AI sentinel staring at corrupted data hologram ‚Äî digital bile flowing across transparent UI ‚Äî motion blur in swiping hand trying to erase it ‚Äî cold-blue lighting, glitch sparks ‚Äî 16:9",
                "Robot frozen mid-step in a field of twitching biomechanical tentacles ‚Äî red eyes narrowed ‚Äî arms pulled back with subtle blur ‚Äî soft squelching floor texture beneath ‚Äî 16:9",
                "Disgusted maintenance bot in a decayed lab, staring at mutated drone corpse ‚Äî oily black liquid dripping ‚Äî fast recoil motion blur in limbs ‚Äî harsh flickering spotlight above ‚Äî 16:9",
                "Futuristic robot stepping away from malformed clone ‚Äî hands raised defensively, fingers flickering ‚Äî red pupils glowing with rejection ‚Äî distorted atmospheric haze ‚Äî 16:9",
                "Robot watching corrupted memory feed projected in mid-air ‚Äî internal face LEDs pulsing red in disgust ‚Äî twitching shoulder with motion blur ‚Äî wires writhing nearby ‚Äî 16:9",
                "Single robot surrounded by rotting mechanical remains ‚Äî lens flinching with blur ‚Äî internal fans emitting high-pitched squeal ‚Äî visible discomfort in body tension ‚Äî dystopian scrapyard ‚Äî 16:9",
                "Disgusted security robot in sewage access tunnel ‚Äî slimy particles splashing on chestplate ‚Äî arm raised with motion blur as it wipes faceplate ‚Äî murky water glowing faint green ‚Äî 16:9",
                "Robot holding shattered containment pod with pulsing organic material inside ‚Äî visible gag in mechanical jaw, blur in head shake ‚Äî lab alarms faintly flashing ‚Äî 16:9",
                "Single android discovering a hybrid organism ‚Äî data error visible on chest HUD ‚Äî recoiling with heavy blur ‚Äî environment warping with reddish-green noise ‚Äî visceral techno-horror ‚Äî 16:9",
                "Robot with one foot sinking into biological sludge ‚Äî shocked red eye, twisting upper body away ‚Äî blur in motion from recoil ‚Äî smoggy toxic waste zone ‚Äî 16:9",
                "Futuristic robot caught mid-repulsion gesture ‚Äî fluids spraying from malfunctioning core nearby ‚Äî blur in raised hand and shifted hips ‚Äî disgust reflected in entire frame ‚Äî 16:9",
                "Single unit in a morgue-like chamber filled with decomposing AIs ‚Äî hand over face grille ‚Äî red eyes dimmed and flickering ‚Äî motion blur in slow retreat ‚Äî oppressive silence ‚Äî 16:9",
                "Disgusted robot lifting a gooey cable with two fingers ‚Äî blur in quick throw gesture ‚Äî fluids trailing in air ‚Äî strong top-down light on polished floor ‚Äî intense repulsion ‚Äî 16:9",
                "Humanoid robot pressed against a wall, backing away from twitching AI limb ‚Äî disgust expression in posture ‚Äî blur in tense hands ‚Äî unsettling ambient light ‚Äî horror-tech fusion ‚Äî 16:9",
                "Robot in surgical bay pulling away from incomplete synthetic organism ‚Äî internal heat vents glowing ‚Äî blur in limbs and glitching facial display ‚Äî sterile horror tone ‚Äî 16:9",
                "AI unit observing a grotesque mutation growing from its own arm ‚Äî internal lights flickering with error ‚Äî shaking hand blurred mid-pullback ‚Äî surreal, medical horror setting ‚Äî 16:9"
            ]
        };

        function updateProgress(message) {
            document.getElementById('progress').textContent = message;
        }

        // Function to get a random unused prompt for an emotion
        function getRandomPrompt(emotion) {
            const prompts = emotionPrompts[emotion];
            if (!prompts || prompts.length === 0) {
                return `A ${emotion} robot in a beautiful scene with motion blur and cinematic lighting ‚Äî 16:9`;
            }

            // Get available prompts (not used yet)
            const availablePrompts = prompts.filter((prompt, index) => !usedPrompts[emotion].includes(index));

            // If all prompts have been used, reset the used list
            if (availablePrompts.length === 0) {
                usedPrompts[emotion] = [];
                return getRandomPrompt(emotion); // Recursive call with reset list
            }

            // Get random prompt from available ones
            const randomIndex = Math.floor(Math.random() * availablePrompts.length);
            const selectedPrompt = availablePrompts[randomIndex];

            // Find the original index and mark it as used
            const originalIndex = prompts.indexOf(selectedPrompt);
            usedPrompts[emotion].push(originalIndex);

            console.log(`Selected prompt ${originalIndex + 1}/20 for ${emotion} emotion`);
            return selectedPrompt;
        }

        async function loadModels() {
            try {
                console.log('Starting to load models from GitHub...');
                updateProgress('Loading face detection model...');
                
                // Load models from GitHub repository (works for online hosting)
                const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
                
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                updateProgress('Loading facial landmarks model...');
                
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                updateProgress('Loading face recognition model...');
                
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                updateProgress('Loading emotion detection model...');
                
                await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
                updateProgress('All models loaded successfully!');
                
                modelsLoaded = true;
                console.log('All Face-API models loaded successfully');
                
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                }, 1000);
                
            } catch (error) {
                console.error('Error loading face-api models:', error);
                updateProgress('Error loading models');
                showError(`Failed to load AI models: ${error.message}`);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }
        }

        async function startCameraStream() {
            const video = document.getElementById('video');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'user'
                    }
                });
                
                video.srcObject = stream;
                console.log('Camera stream started');
                
            } catch (error) {
                console.error('Error starting camera:', error);
                showError('Camera failed to start.');
            }
        }

        async function startCamera() {
            const video = document.getElementById('video');
            const button = document.getElementById('start-camera');
            
            try {
                await startCameraStream();
                button.style.display = 'none';
                hideError();
                
                video.addEventListener('play', () => {
                    const canvas = document.getElementById('canvas');

                    // Function to resize canvas to match displayed video dimensions
                    const resizeCanvas = () => {
                        const rect = video.getBoundingClientRect();
                        canvas.width = rect.width;
                        canvas.height = rect.height;
                        canvas.style.width = rect.width + 'px';
                        canvas.style.height = rect.height + 'px';
                    };

                    // Initial resize
                    resizeCanvas();

                    // Resize canvas when window is resized
                    window.addEventListener('resize', resizeCanvas);

                    startDetection();
                });
                
                console.log('Camera started successfully');
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                showError('Unable to access camera. Please ensure you have granted camera permissions.');
            }
        }

        function startDetection() {
            if (detectionInterval) {
                clearInterval(detectionInterval);
            }

            // Continuous detection every 100ms for smooth real-time feedback
            detectionInterval = setInterval(async () => {
                await detectEmotions();
            }, 100);

            console.log('Started continuous emotion detection');
        }



        async function detectEmotions() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            if (!video || !canvas || !modelsLoaded) return;

            try {
                const detections = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                        inputSize: 416,
                        scoreThreshold: 0.3
                    }))
                    .withFaceExpressions();

                // Get the displayed video dimensions for proper scaling
                const rect = video.getBoundingClientRect();
                const displaySize = { width: rect.width, height: rect.height };

                // Use faceapi's built-in resizing which handles scaling properly
                const resizedDetections = faceapi.resizeResults(detections, displaySize);

                // Clear canvas
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw detections with proper scaling
                faceapi.draw.drawDetections(canvas, resizedDetections);
                faceapi.draw.drawFaceExpressions(canvas, resizedDetections);

                if (detections.length > 0) {
                    // Get all emotion expressions
                    const expressions = detections[0].expressions;
                    let maxEmotion = 'neutral';
                    let maxValue = 0;

                    // Find highest confidence emotion
                    Object.entries(expressions).forEach(([emotion, value]) => {
                        if (value > maxValue) {
                            maxEmotion = emotion;
                            maxValue = value;
                        }
                    });

                    // Update debug panel with real-time values
                    updateDebugPanel(expressions);

                    // Store emotion in history for averaging
                    emotionHistory.push({
                        emotion: maxEmotion,
                        confidence: maxValue,
                        timestamp: Date.now()
                    });
                    
                    // Keep only last 30 detections (about 3 seconds worth)
                    if (emotionHistory.length > 30) {
                        emotionHistory = emotionHistory.slice(-30);
                    }
                    
                    // Update emotion immediately when there's a strong, consistent change
                    const now = Date.now();
                    const dominantEmotion = getDominantEmotion();
                    
                    // Update if:
                    // 1. Strong emotion detected (>40% confidence)
                    // 2. Different emotion with decent confidence (>25%)
                    // 3. Been too long since last update (5 seconds max)
                    const shouldUpdate = 
                        maxValue > 0.4 || 
                        (dominantEmotion !== currentEmotion && maxValue > 0.25) ||
                        (now - lastUpdateTime > 5000);
                    
                    if (shouldUpdate) {
                        updateEmotion(dominantEmotion);
                        currentEmotion = dominantEmotion;
                        lastUpdateTime = now;
                    }
                    
                    // Show real-time detection for strong emotions
                    if (maxValue > 0.3) {
                        console.log(`Strong emotion detected: ${maxEmotion} (${(maxValue * 100).toFixed(1)}%)`);
                    }
                } else {
                    updateEmotion('default');
                    updateDebugPanel({});
                }
            } catch (error) {
                console.error('Error detecting emotions:', error);
            }
        }

        function getDominantEmotion() {
            if (emotionHistory.length === 0) return 'neutral';
            
            // Get the most recent emotions (last 2 seconds)
            const recentEmotions = emotionHistory.slice(-20);
            
            // Count occurrences of each emotion in recent history
            const emotionCounts = {};
            const emotionConfidences = {};
            
            recentEmotions.forEach(entry => {
                emotionCounts[entry.emotion] = (emotionCounts[entry.emotion] || 0) + 1;
                emotionConfidences[entry.emotion] = Math.max(
                    emotionConfidences[entry.emotion] || 0, 
                    entry.confidence
                );
            });
            
            // Find emotion with highest occurrence and confidence
            let dominantEmotion = 'neutral';
            let maxScore = 0;
            
            Object.entries(emotionCounts).forEach(([emotion, count]) => {
                const confidence = emotionConfidences[emotion] || 0;
                const score = count * confidence;
                
                // Boost non-neutral emotions to make detection more sensitive
                const boost = emotion !== 'neutral' ? 1.5 : 1;
                const finalScore = score * boost;
                
                if (finalScore > maxScore) {
                    dominantEmotion = emotion;
                    maxScore = finalScore;
                }
            });
            
            return dominantEmotion;
        }

        function updateDebugPanel(expressions) {
            const debugElement = document.getElementById('emotion-values');
            if (!debugElement) return;
            
            if (Object.keys(expressions).length === 0) {
                debugElement.innerHTML = '<span style="color: #ff6b6b;">No face detected</span>';
                return;
            }
            
            // Sort emotions by confidence
            const sortedEmotions = Object.entries(expressions)
                .sort(([,a], [,b]) => b - a)
                .map(([emotion, value]) => {
                    const percentage = (value * 100).toFixed(1);
                    const color = value > 0.3 ? '#4ecdc4' : value > 0.1 ? '#ffe66d' : '#95a5a6';
                    return `<span style="color: ${color};">${emotion}: ${percentage}%</span>`;
                });
            
            debugElement.innerHTML = sortedEmotions.join(' | ');
        }

        function updateEmotion(emotion) {
            const status = statusIcons[emotion] || statusIcons.default;
            document.getElementById('emoji').textContent = status.emoji;
            document.getElementById('emotion-text').textContent = status.name;

            // Add visual feedback for updates
            const emojiElement = document.getElementById('emoji');
            emojiElement.style.transform = 'scale(1.2)';
            setTimeout(() => {
                emojiElement.style.transform = 'scale(1)';
            }, 200);

            console.log(`Emotion updated to: ${emotion} at ${new Date().toLocaleTimeString()}`);

            // Trigger AI art generation for significant emotion changes
            if (emotion !== 'default' && emotion !== lastGeneratedEmotion && !isGeneratingArt) {
                const confidence = getEmotionConfidence(emotion);
                if (confidence > 0.3) { // Only generate for confident detections
                    generateAIArt(emotion, confidence);
                }
            }
        }

        function getEmotionConfidence(targetEmotion) {
            if (emotionHistory.length === 0) return 0;

            const recentEmotions = emotionHistory.slice(-10);
            const emotionEntries = recentEmotions.filter(entry => entry.emotion === targetEmotion);

            if (emotionEntries.length === 0) return 0;

            return Math.max(...emotionEntries.map(entry => entry.confidence));
        }

        async function generateAIArt(emotion, confidence) {
            if (isGeneratingArt) return;

            isGeneratingArt = true;
            lastGeneratedEmotion = emotion;

            // Get a random unused prompt for this emotion
            const selectedPrompt = getRandomPrompt(emotion);

            // Update UI to show loading state
            updateAIArtStatus('generating', emotion);
            showAIArtLoading(true);

            // Update prompt preview immediately
            const promptElement = document.getElementById('prompt-preview');
            const emotionTag = document.getElementById('current-emotion-tag');
            if (promptElement && emotionTag) {
                emotionTag.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                promptElement.textContent = selectedPrompt;
            }

            try {
                console.log(`Generating AI art for emotion: ${emotion} (confidence: ${confidence})`);
                console.log(`Using prompt: ${selectedPrompt.substring(0, 100)}...`);

                const response = await fetch(`${apiBaseUrl}/generate-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        emotion: emotion,
                        confidence: confidence,
                        prompt: selectedPrompt
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.imageUrl) {
                    displayAIArt(data.imageUrl, emotion, selectedPrompt);
                    updateAIArtStatus('complete', emotion);
                } else {
                    throw new Error(data.error || 'Failed to generate image');
                }

            } catch (error) {
                console.error('Error generating AI art:', error);
                updateAIArtStatus('error', emotion);
                showAIArtError(error.message);
            } finally {
                showAIArtLoading(false);

                // Set cooldown to prevent too frequent generations
                setTimeout(() => {
                    isGeneratingArt = false;
                }, generationCooldown);
            }
        }

        function updateAIArtStatus(status, emotion) {
            const statusElement = document.getElementById('ai-status');
            const emotionTag = document.getElementById('current-emotion-tag');
            const promptPanel = document.getElementById('prompt-panel');
            const promptElement = document.getElementById('prompt-preview');

            switch (status) {
                case 'generating':
                    statusElement.innerHTML = '<div class="live-dot"></div>Generating';
                    statusElement.style.background = 'var(--apple-orange)';
                    if (emotionTag) emotionTag.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                    if (promptElement) promptElement.textContent = 'Generating AI art based on your emotion...';
                    break;
                case 'complete':
                    statusElement.innerHTML = '<div class="live-dot"></div>Complete';
                    statusElement.style.background = 'var(--apple-green)';
                    break;
                case 'error':
                    statusElement.innerHTML = '‚ö†Ô∏è Error';
                    statusElement.style.background = 'var(--apple-red)';
                    break;
                default:
                    statusElement.innerHTML = '<div class="live-dot"></div>Ready';
                    statusElement.style.background = 'var(--apple-purple)';
            }
        }

        function showAIArtLoading(show) {
            const loadingElement = document.getElementById('ai-loading');
            if (loadingElement) {
                loadingElement.style.display = show ? 'flex' : 'none';
            }
        }

        function displayAIArt(imageUrl, emotion, prompt) {
            const imageElement = document.getElementById('ai-art-image');
            const placeholderElement = document.getElementById('ai-placeholder');
            const promptPanel = document.getElementById('prompt-panel');
            const promptElement = document.getElementById('prompt-preview');
            const emotionTag = document.getElementById('current-emotion-tag');

            if (imageElement && placeholderElement) {
                // Hide placeholder and show image
                placeholderElement.style.display = 'none';
                imageElement.src = imageUrl;
                imageElement.style.display = 'block';
                imageElement.onload = () => {
                    imageElement.style.opacity = '1';
                };

                // Update prompt panel in emotion panel
                if (promptElement && emotionTag) {
                    emotionTag.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                    promptElement.textContent = prompt;
                }

                console.log(`AI art displayed for emotion: ${emotion}`);
            }
        }

        function showAIArtError(message) {
            const placeholderElement = document.getElementById('ai-placeholder');
            if (placeholderElement) {
                placeholderElement.innerHTML = `
                    <div class="title">Generation Failed</div>
                    <p class="description">${message}</p>
                `;
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('error-message');
            if (errorMessage) {
                errorMessage.textContent = message;
            } else {
                errorDiv.innerHTML = `<div class="error-title">Something went wrong</div><div class="error-message">${message}</div>`;
            }
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // Check API health and load models when page loads
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${apiBaseUrl}/health`);
                if (response.ok) {
                    console.log('‚úÖ AI Art API is available');
                    updateAIArtStatus('ready');
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è AI Art API not available:', error.message);
                updateAIArtStatus('error');
                const placeholderElement = document.getElementById('ai-placeholder');
                if (placeholderElement) {
                    placeholderElement.innerHTML = `
                        <div class="icon">üîå</div>
                        <div class="title">API Not Available</div>
                        <p class="description">Start the backend server to enable AI art generation. See README_API_SETUP.md for instructions.</p>
                    `;
                }
            }
        }

        // Load models and check API when page loads
        window.addEventListener('load', () => {
            loadModels();
            checkAPIHealth();
        });
    </script>
</body>
</html>

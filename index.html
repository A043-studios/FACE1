<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facial Emotion Detector</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* Dark Professional Design System */
        :root {
            /* Dark theme colors inspired by the reference */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #3a3a3a;

            /* Surface colors */
            --surface-primary: #2d2d2d;
            --surface-secondary: #353535;
            --surface-elevated: #404040;

            /* Accent colors */
            --accent-blue: #4A9EFF;
            --accent-green: #4AFF88;
            --accent-orange: #FF8A4A;
            --accent-red: #FF4A4A;
            --accent-purple: #8A4AFF;

            /* Legacy color mappings for compatibility */
            --apple-blue: #4A9EFF;
            --apple-blue-dark: #3A8EEF;
            --apple-green: #4AFF88;
            --apple-orange: #FF8A4A;
            --apple-red: #FF4A4A;
            --apple-purple: #8A4AFF;

            /* Glass effect colors */
            --glass-bg: rgba(45, 45, 45, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: rgba(0, 0, 0, 0.3);

            /* Background */
            --bg-gradient: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
            --surface-glass: rgba(45, 45, 45, 0.8);
            --surface-glass-hover: rgba(53, 53, 53, 0.8);

            /* Text colors optimized for dark theme */
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --text-tertiary: #808080;
            --text-muted: #606060;
            --separator: rgba(255, 255, 255, 0.1);

            /* Spacing system */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 48px;
            --spacing-xxxl: 64px;

            /* Border radius - minimal */
            --radius-sm: 2px;
            --radius-md: 4px;
            --radius-lg: 6px;
            --radius-xl: 8px;

            /* Minimal shadows */
            --shadow-glass: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-glass-lg: 0 4px 12px rgba(0, 0, 0, 0.15);

            /* Legacy shadow mappings */
            --shadow-sm: var(--shadow-glass);
            --shadow-md: var(--shadow-glass);
            --shadow-lg: var(--shadow-glass-lg);
            --shadow-xl: var(--shadow-glass-lg);
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
            font-weight: 400;
            position: relative;
            letter-spacing: -0.01em;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-gradient);
            z-index: -1;
        }

        .app-container {
            width: 100%;
            min-height: 100vh;
            padding: 0;
            position: relative;
        }



        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            grid-template-rows: 1fr;
            gap: var(--spacing-lg);
            padding: var(--spacing-lg);
            align-items: stretch;
            width: 100%;
            min-height: calc(100vh - 100px);
            position: relative;
            z-index: 2;
        }

        /* Column Layout */
        .info-column {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            height: 100%;
        }

        .content-column {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            height: 100%;
        }

        /* Panel Header */
        .panel-header {
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--separator);
        }

        .panel-header h1 {
            font-size: clamp(1.25rem, 2.5vw, 1.75rem);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }

        .panel-header .subtitle {
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.4;
        }

        .emotion-panel {
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-glass);
            border: 1px solid var(--glass-border);
        }

        .emoji-display {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .emoji {
            font-size: 4rem;
            margin: var(--spacing-md) 0;
            display: block;
            transition: all 0.2s ease;
        }

        .status-text {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--text-primary);
            margin: var(--spacing-sm) 0;
            letter-spacing: -0.01em;
        }

        .status-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 400;
            margin-bottom: var(--spacing-lg);
            line-height: 1.4;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            background: var(--accent-green);
            color: var(--bg-primary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-md);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }

        .video-section {
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-glass);
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .video-header {
            background: var(--surface-secondary);
            color: var(--text-primary);
            padding: var(--spacing-md);
            text-align: center;
            border-bottom: 1px solid var(--separator);
        }

        .video-header h2 {
            margin: 0;
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            overflow: hidden;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        video {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .debug-panel {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin: var(--spacing-lg) 0;
            border: 1px solid var(--separator);
        }

        .debug-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
            letter-spacing: -0.01em;
        }

        .debug-content {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
            background: var(--bg-secondary);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            border: 1px solid var(--separator);
        }

        /* Prompt Panel */
        .prompt-panel {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin: var(--spacing-lg) 0;
            border: 1px solid var(--separator);
        }

        .prompt-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
            letter-spacing: -0.01em;
        }

        .prompt-content .emotion-tag {
            display: inline-block;
            background: var(--accent-blue);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-sm);
        }

        .prompt-content .prompt-preview {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin: 0;
            font-style: italic;
        }

        .tips-card {
            background: rgba(59, 130, 246, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
            border: 1px solid var(--glass-border);
            border-left: 4px solid var(--apple-blue);
            box-shadow: var(--shadow-glass);
        }

        .tips-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--apple-blue);
            margin: 0 0 var(--spacing-sm) 0;
        }

        .tips-content {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* AI Art Overlay Styles */
        .ai-art-overlay {
            position: absolute;
            bottom: var(--spacing-md);
            right: var(--spacing-md);
            width: 300px;
            max-width: 40%;
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-glass);
            border: 1px solid var(--glass-border);
            z-index: 10;
        }

        .ai-art-overlay .ai-art-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .ai-art-overlay .ai-art-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0;
            letter-spacing: -0.01em;
        }

        .ai-art-overlay .ai-art-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            background: var(--accent-purple);
            color: white;
            padding: 3px 6px;
            border-radius: var(--radius-sm);
            font-size: 0.65rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ai-art-overlay .ai-art-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-sm);
            box-shadow: var(--shadow-glass);
        }

        .ai-art-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-lg);
            transition: opacity 0.3s ease;
        }

        .ai-art-overlay .ai-art-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: var(--spacing-md);
        }

        .ai-art-overlay .ai-art-placeholder .title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-xs) 0;
        }

        .ai-art-overlay .ai-art-placeholder .description {
            font-size: 0.75rem;
            line-height: 1.4;
            margin: 0;
        }

        .ai-art-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
        }

        .ai-art-loading .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--text-tertiary);
            border-top: 3px solid var(--apple-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-sm);
        }

        .ai-art-loading .text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .ai-art-info {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-glass);
        }

        .ai-art-info .emotion-tag {
            display: inline-block;
            background: var(--apple-blue);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-sm);
        }

        .ai-art-info .prompt-preview {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin: 0;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-lg);
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            text-decoration: none;
            min-width: 140px;
            letter-spacing: -0.01em;
            box-shadow: var(--shadow-glass);
            border: 1px solid transparent;
        }

        .btn-primary:hover {
            background: var(--apple-blue-dark);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: var(--spacing-xxxl);
            background: var(--surface-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-glass-lg);
            border: 1px solid var(--glass-border);
            text-align: center;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--text-tertiary);
            border-top: 3px solid var(--apple-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-lg);
        }

        .loading-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
            letter-spacing: -0.01em;
        }

        .loading-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin: 0;
            font-weight: 400;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-card {
            background: rgba(239, 68, 68, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-left: 4px solid var(--apple-red);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
            box-shadow: var(--shadow-glass);
        }

        .error-title {
            color: var(--apple-red);
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 var(--spacing-sm) 0;
        }

        .error-message {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin: 0;
            line-height: 1.5;
        }

        .privacy-note {
            background: rgba(16, 185, 129, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin: var(--spacing-xl) var(--spacing-xl);
            text-align: center;
            border: 1px solid rgba(16, 185, 129, 0.3);
            box-shadow: var(--shadow-glass);
        }

        .error-card {
            margin: var(--spacing-lg) var(--spacing-xl);
        }

        .privacy-note .icon {
            font-size: 1.5rem;
            margin-bottom: var(--spacing-sm);
        }

        .privacy-note .title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-xs) 0;
        }

        .privacy-note .description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        .footer {
            text-align: center;
            padding: var(--spacing-xxl) var(--spacing-xl);
            margin-top: var(--spacing-xxxl);
            border-top: 1px solid var(--separator);
            width: 100%;
        }

        .footer-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
        }

        .footer-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
                padding: var(--spacing-md);
            }

            .info-column {
                order: 2;
            }

            .content-column {
                order: 1;
            }

            .ai-art-overlay {
                width: 250px;
                max-width: 35%;
            }
        }

        @media (max-width: 768px) {
            .main-grid {
                padding: var(--spacing-sm);
                gap: var(--spacing-sm);
            }

            .panel-header {
                margin-bottom: var(--spacing-md);
                padding-bottom: var(--spacing-sm);
            }

            .ai-art-overlay {
                width: 200px;
                max-width: 45%;
                bottom: var(--spacing-sm);
                right: var(--spacing-sm);
            }
        }

        @media (max-width: 768px) {
            .hero-section {
                padding: var(--spacing-xl) var(--spacing-md);
            }

            .main-grid {
                padding: var(--spacing-md);
            }

            .privacy-note {
                margin: var(--spacing-xl) var(--spacing-md);
            }

            .error-card {
                margin: var(--spacing-lg) var(--spacing-md);
            }

            .footer {
                padding: var(--spacing-xxl) var(--spacing-md);
            }

            .hero-section h1 {
                font-size: 2.5rem;
            }

            .emoji {
                font-size: 4.5rem;
            }

            .status-text {
                font-size: 1.5rem;
            }

            .btn-primary {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .hero-section {
                padding: var(--spacing-lg) var(--spacing-sm);
            }

            .main-grid {
                padding: var(--spacing-sm);
            }

            .privacy-note {
                margin: var(--spacing-lg) var(--spacing-sm);
            }

            .error-card {
                margin: var(--spacing-md) var(--spacing-sm);
            }

            .footer {
                padding: var(--spacing-xl) var(--spacing-sm);
            }

            .hero-section h1 {
                font-size: 2rem;
            }

            .emoji {
                font-size: 3.5rem;
            }

            .emotion-panel,
            .video-section {
                padding: var(--spacing-lg);
            }
        }

        /* Large screen optimization */
        @media (min-width: 1600px) {
            .main-grid {
                grid-template-columns: 1fr 2fr;
                padding: var(--spacing-xxl) var(--spacing-xxxl);
                gap: var(--spacing-xxl);
            }

            .hero-section {
                padding: var(--spacing-xxxl) var(--spacing-xxxl) var(--spacing-xxl);
            }

            .privacy-note {
                margin: var(--spacing-xl) var(--spacing-xxxl);
            }

            .error-card {
                margin: var(--spacing-lg) var(--spacing-xxxl);
            }

            .footer {
                padding: var(--spacing-xxl) var(--spacing-xxxl);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">


        <!-- Loading State -->
        <div id="loading" class="loading-container">
            <div class="loading-spinner"></div>
            <h2 class="loading-title">Loading AI Models</h2>
            <p class="loading-subtitle" id="progress">Initializing neural networks...</p>
        </div>

        <!-- Main Application -->
        <div id="main-content" style="display: none;">
            <div class="main-grid">
                <!-- Left Column: Info Panel (33%) -->
                <div class="info-column">
                    <!-- Emotion Display Panel -->
                    <div class="emotion-panel">
                        <div class="panel-header">
                            <h1>Facial Emotion Detector</h1>
                            <p class="subtitle">Experience the future of AI-powered emotion recognition with real-time analysis using your camera</p>
                        </div>

                        <div class="live-indicator">
                            <div class="live-dot"></div>
                            Live Detection
                        </div>

                        <div class="emoji-display">
                            <div class="emoji" id="emoji">ğŸ˜</div>
                            <div class="status-text">You look <span id="emotion-text">neutral</span></div>
                            <p class="status-subtitle">AI is analyzing your facial expressions in real-time</p>
                        </div>

                        <!-- Debug Panel -->
                        <div class="debug-panel">
                            <div class="debug-title">Emotion Analysis</div>
                            <div class="debug-content">
                                <div id="emotion-values">Waiting for face detection...</div>
                            </div>
                        </div>

                        <!-- AI Prompt Preview -->
                        <div class="prompt-panel" id="prompt-panel">
                            <div class="prompt-title">AI Art Prompt</div>
                            <div class="prompt-content">
                                <div class="emotion-tag" id="current-emotion-tag">Neutral</div>
                                <p class="prompt-preview" id="prompt-preview">Waiting for emotion detection...</p>
                            </div>
                        </div>

                        <!-- Tips Card -->
                        <div class="tips-card">
                            <div class="tips-title">Tips for Best Results</div>
                            <div class="tips-content">
                                Make exaggerated expressions and hold them for 2-3 seconds:<br>
                                ğŸ˜€ Big smile â€¢ ğŸ˜¢ Deep frown â€¢ ğŸ˜  Furrow brow â€¢ ğŸ˜² Open mouth wide
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Camera Feed (66%) -->
                <div class="content-column">
                    <!-- Video Section -->
                    <div class="video-section">
                        <div class="video-header">
                            <h2>Live Camera Feed</h2>
                        </div>

                        <div class="video-container">
                            <video id="video" width="640" height="480" autoplay muted playsinline></video>
                            <canvas id="canvas"></canvas>

                            <!-- AI Art Panel - Overlaid in bottom right -->
                            <div class="ai-art-overlay">
                                <div class="ai-art-header">
                                    <h3 class="ai-art-title">AI Art Generation</h3>
                                    <div class="ai-art-indicator" id="ai-status">
                                        <div class="live-dot"></div>
                                        Ready
                                    </div>
                                </div>

                                <div class="ai-art-container" id="ai-art-container">
                                    <div class="ai-art-placeholder" id="ai-placeholder">
                                        <div class="title">Emotion-Based Art</div>
                                        <p class="description">AI will generate beautiful artwork based on your detected emotions. Start the camera to begin!</p>
                                    </div>
                                    <img id="ai-art-image" class="ai-art-image" style="display: none;" alt="AI Generated Art">
                                    <div class="ai-art-loading" id="ai-loading" style="display: none;">
                                        <div class="spinner"></div>
                                        <div class="text">Generating art...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="padding: var(--spacing-lg); text-align: center;">
                            <button id="start-camera" class="btn-primary" onclick="startCamera()">
                                ğŸ“· Start Camera
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Display -->
            <div id="error" class="error-card" style="display: none;">
                <div class="error-title">Something went wrong</div>
                <div class="error-message" id="error-message"></div>
            </div>

            <!-- Privacy Note -->
            <div class="privacy-note">
                <div class="icon">ğŸ”’</div>
                <div class="title">Privacy First</div>
                <p class="description">Your video never leaves your device. All AI processing happens locally in your browser for complete privacy and security.</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-title">Built with Face-API.js and TensorFlow.js</div>
            <p class="footer-description">Detects seven emotions: Happy, Sad, Angry, Fearful, Disgusted, Surprised, and Neutral</p>
        </div>
    </div>

    <script>
        const statusIcons = {
            default: { emoji: 'ğŸ˜', name: 'neutral' },
            neutral: { emoji: 'ğŸ˜', name: 'neutral' },
            happy: { emoji: 'ğŸ˜€', name: 'happy' },
            sad: { emoji: 'ğŸ˜¥', name: 'sad' },
            angry: { emoji: 'ğŸ˜ ', name: 'angry' },
            fearful: { emoji: 'ğŸ˜¨', name: 'fearful' },
            disgusted: { emoji: 'ğŸ¤¢', name: 'disgusted' },
            surprised: { emoji: 'ğŸ˜²', name: 'surprised' },
        };

        let modelsLoaded = false;
        let detectionInterval = null;
        let currentEmotion = 'neutral';
        let emotionHistory = [];
        let lastUpdateTime = Date.now();

        // AI Art Generation variables
        let isGeneratingArt = false;
        let lastGeneratedEmotion = null;
        let apiBaseUrl = 'http://localhost:3001/api';
        let generationCooldown = 5000; // 5 seconds between generations

        // Prompt tracking for each emotion
        let usedPrompts = {
            happy: [],
            neutral: [],
            sad: [],
            angry: [],
            fearful: [],
            disgusted: [],
            surprised: []
        };

        // Emotion-specific prompts (20 per emotion)
        const emotionPrompts = {
            happy: [
                "Joyful humanoid robot standing in a sunlit flower field â€” white glossy armor gleaming in the sunlight â€” one hand mid-wave with soft motion blur â€” surrounded by wildflowers in bloom â€” bright blue sky with fluffy clouds â€” warm and optimistic tone â€” 16:9",
                "Smiling robot with glowing eyes and rounded features â€” skipping through a field of daisies, motion blur on one foot â€” golden-hour lighting â€” sun rays filtering through petals â€” playful and serene future-nature fusion â€” 16:9",
                "Happy robot with curved chrome limbs dancing gently in a meadow of sunflowers â€” subtle motion blur on arms â€” butterflies fluttering in the background â€” cinematic soft-focus lens â€” pastel tones and peaceful mood â€” 16:9",
                "Friendly robot with a ceramic finish and gold details, sitting in a patch of poppies â€” head tilted slightly with expressive glow â€” hand raised in a blurred gesture of joy â€” colorful floral field stretching into the distance â€” ambient golden lighting â€” 16:9",
                "Single humanoid robot spinning playfully in a field of lavender â€” arms extended, motion blur showing movement â€” warm breeze, flowers swaying â€” bright, dreamy sky above â€” joyful organic-mechanical harmony â€” 16:9",
                "White-armored robot with floral crown, walking slowly through tall wildflowers â€” slight motion blur in limbs â€” vibrant colors, butterflies, birds in the background â€” soft cinematic sunlight and nature's harmony â€” 16:9",
                "Expressive robot kneeling in a flower field, inspecting a single glowing bloom â€” one arm blurred from reaching out â€” colorful meadow under radiant afternoon light â€” tranquil, gentle futuristic vision â€” 16:9",
                "Cheerful robot with an LED faceplate showing smiling eyes â€” running joyfully through tulips, motion blur behind â€” trails of petals caught mid-air â€” lush, bright, immersive landscape â€” 16:9",
                "Solo robot with a mirrored visor reflecting fields of flowers â€” mid-jump with light motion blur â€” vibrant spring palette, rolling hills of blossoms in the background â€” playful and poetic AI in nature â€” 16:9",
                "Warmly lit robot with golden joints lying in a field of mixed wildflowers â€” arm raised with motion blur, waving at the sky â€” serene floral horizon â€” peaceful, childlike wonder meets future tech â€” 16:9",
                "Delighted humanoid robot twirling gently in a vast field of yellow buttercups â€” arms outstretched with trailing motion blur â€” sunset glow wrapping the landscape â€” petals drifting in mid-air â€” joyful and poetic scene â€” 16:9",
                "Happy robot with soft-rounded features walking barefoot-style through tall grass and wildflowers â€” hand brushing the blossoms with light motion blur â€” glowing forest edge in the distance â€” uplifting and cinematic â€” 16:9",
                "Cheerful robot with blue-tinted visor sitting under a blossoming tree in a flower field â€” waving with a slightly blurred arm â€” sunlight sparkling through leaves â€” peaceful, heartwarming scene â€” 16:9",
                "Robot with heart-shaped LED display bouncing lightly in a pink flower meadow â€” motion blur on lower limbs and falling blossoms â€” soft clouds above, lens flare glints â€” playful nature-tech harmony â€” 16:9",
                "Smiling AI figure skipping through rows of orange marigolds â€” blurred motion in raised knee and outstretched hand â€” radiant golden-hour sun casting long shadows â€” bright and spirited â€” 16:9",
                "Curious robot surrounded by blooming cosmos flowers â€” gently spinning in place with motion-blurred arms â€” sun-dappled field with insects and light breeze â€” vibrant and serene mood â€” 16:9",
                "Playful robot holding a bouquet of wildflowers, caught mid-jump â€” trailing motion blur behind legs â€” lush countryside horizon â€” cheerful, youthful energy â€” sunlit and cinematic â€” 16:9",
                "Robot with metallic freckles and expressive eyes lying on its back in a violet flower field â€” slowly raising one hand with blur trail â€” dreamy sky with birds flying above â€” tranquil joy â€” 16:9",
                "Dancing robot in a daisy-covered clearing â€” motion blur on hips and feet to suggest rhythm â€” nature surrounds with soft fog at sunrise â€” harmonic fusion of innocence and tech â€” 16:9",
                "Happy robot gently tossing flower petals into the air â€” soft motion blur as petals float and arms move â€” surrounded by lush blooms, clear sky, and glowing morning light â€” whimsical and cinematic â€” 16:9"
            ],
            neutral: [
                "Single humanoid robot in glossy white armor with gold neck accents â€” subtle motion blur in one extended arm â€” cinematic spotlight from above â€” black background with minimal reflections â€” futuristic, clean design â€” 16:9",
                "One sleek robot with reflective obsidian visor and asymmetrical shoulder plating â€” arm slightly blurred mid-gesture â€” foggy sci-fi backdrop with rim light â€” ultra-polished surfaces â€” moody cinematic feel â€” 16:9",
                "Futuristic robot with dark chrome chest panel and matte helmet â€” turning slightly, with motion blur trailing behind â€” strong key light from upper left â€” background fading into soft tech shadows â€” 16:9",
                "Solitary robot with exposed joint mechanics and illuminated torso â€” walking forward with legs in motion blur â€” ambient glow and scattered particles â€” high realism and sci-fi depth â€” 16:9",
                "Front-facing humanoid robot with narrow facial plate and fine surface scratches â€” motion blur around shoulder as if just moved â€” soft industrial lighting â€” isolated tech stage â€” 16:9",
                "Single robot with gold-trimmed helmet and layered chest plating â€” half body caught in motion blur suggesting a swift turn â€” glossy floor reflections â€” deep space ambiance â€” 16:9",
                "Robot in high-gloss ceramic armor with segmented limbs â€” light motion blur on one side, simulating shift in stance â€” focused spotlight beam â€” tech cave background â€” cinematic vibe â€” 16:9",
                "Lone AI sentinel with monochrome design, intricate spine structure visible â€” motion blur from rising arm â€” dramatic low angle view â€” dust particles in ambient backlight â€” 16:9",
                "Humanoid robot in matte white finish with asymmetric visor design â€” slight motion blur across lower body, mid-step â€” soft gradient background with tech haze â€” elegant sci-fi aesthetic â€” 16:9",
                "Heroic robot in bold stance, front-lit with subtle warm tones â€” head tilt causing slight blur effect â€” high-detail joints and chest plating â€” isolated on dark moody backdrop â€” 16:9",
                "Minimalist humanoid robot in brushed steel finish â€” one arm extended, fingertips slightly motion blurred â€” soft spotlight illuminating reflective surfaces â€” dark void background with subtle tech glows â€” 16:9",
                "Single robot with matte black exoskeleton and luminous core â€” torso twist creating a gentle motion blur â€” floating ambient particles â€” low ambient light with directional top lighting â€” sci-fi tech noir style â€” 16:9",
                "Futuristic android with geometric plating and no visible face â€” motion blur around knees as if shifting weight â€” background of smoky volumetric light beams â€” crisp edge lighting and atmospheric depth â€” 16:9",
                "Single AI unit with modular chest design and amber accent lights â€” captured mid-step with blurred foot trailing â€” metallic industrial setting with haze and reflections â€” moody futuristic minimalism â€” 16:9",
                "Angular robot design with sculpted armor plates and vented shoulder joints â€” left arm blurred while raising â€” background of subtle backlight silhouettes â€” stark, minimal color palette â€” 16:9",
                "Solitary bipedal robot with sharp jawline and brushed titanium finish â€” turning head with motion blur sweep â€” dark environment with only floor reflections and narrow beam illumination â€” quiet, precise energy â€” 16:9",
                "Robot with a neutral posture, mid-walk in low gravity â€” soft motion blur across hips and hands â€” dimly lit corridor with glowing data lines â€” quiet anticipation and weightless futurism â€” 16:9",
                "Clean humanoid robot with segmented plating and internal light veins â€” motion blur around wrist as it rotates â€” studio-lit with a cold color temperature â€” black background with faint lens flares â€” 16:9",
                "Neutral stance robot with hexagonal limb details and a non-reflective matte surface â€” barely visible motion blur in subtle micro-adjustment pose â€” volumetric light shafts cutting through darkness â€” minimalistic elegance â€” 16:9",
                "AI unit with wide shoulder frame and illuminated helmet visor â€” captured just after a pivot turn with blurred limb edges â€” crisp lighting from the left â€” cold, atmospheric backdrop with engineered serenity â€” 16:9"
            ],
            sad: [
                "Lonely humanoid robot in matte grey armor, standing motionless in heavy rain â€” droplets trailing down smooth plating â€” blue hour lighting â€” soft motion blur in falling rain â€” moody urban background â€” 16:9",
                "Sad robot with dimly lit visor, shoulders slumped â€” cold rain pouring over a reflective chest plate â€” dark alley with neon reflections on wet ground â€” emotional silence â€” 16:9",
                "Single robot in a long raincoat-style exterior shell â€” slow motion blur as rain slides off â€” surrounded by puddles in a dystopian street â€” blue-purple color grading â€” 16:9",
                "Broken-looking robot under a flickering streetlamp in the rain â€” water pooling at its feet â€” soft motion blur from distant cars â€” rainy cityscape backdrop â€” deep, cinematic sadness â€” 16:9",
                "Weathered humanoid robot standing still in a stormy field â€” rivulets of rain cascading down its faceplate â€” arms loose by its side â€” grayscale scene with faint warm backlight â€” 16:9",
                "Melancholy robot looking downward, motion blur in streaming rain around â€” reflective armor dulled by water â€” soft spotlight overhead â€” muted reflections in puddles â€” 16:9",
                "Single robot under a collapsed structure in the rain â€” flickering internal lights â€” streaks of rain catching environmental light â€” sadness in stillness â€” worn-down futuristic vibe â€” 16:9",
                "Chrome-faced robot turned slightly away, rain streaming across reflective surface â€” overcast lighting â€” long shadows and light motion blur in raindrops â€” atmosphere heavy with isolation â€” 16:9",
                "Abandoned service robot standing at the edge of a flooded sidewalk â€” one leg partially submerged â€” motion blur in slanted rain â€” neon sign flickering in background â€” 16:9",
                "Silent sentinel-style robot, arms crossed, standing beneath a broken shelter â€” rain dripping from helmet â€” moody contrast lighting â€” cinematic sci-fi noir â€” 16:9",
                "Sad robot standing alone on a rooftop in the rain â€” motion blur in wind-blown droplets â€” expressionless visor tilted down â€” minimal lighting and blurred skyline â€” 16:9",
                "Single robot framed in a rainy, overgrown landscape â€” moss-covered joints â€” standing still as raindrops blur in the foreground â€” post-apocalyptic sorrow â€” 16:9",
                "Robot with glowing blue chest light dimmed â€” kneeling in the rain with hands resting on thighs â€” streaks of water obscuring body lines â€” sorrowful and resigned tone â€” 16:9",
                "Old-generation robot slowly rusting in the rain â€” motion blur on water streams â€” solitary placement in middle of empty road â€” dim ambient glow from foggy lights â€” 16:9",
                "Futuristic android leaning against a wall in heavy rain â€” wet surface reflections all around â€” blurred cars in background â€” eyes turned off â€” sense of loss â€” 16:9",
                "Slender robot standing with arms by its side on a rain-drenched bridge â€” motion blur on falling rain and distant vehicles â€” dramatic key light from behind â€” cold sadness â€” 16:9",
                "Robot alone at an abandoned train platform â€” flickering screen light on wet plating â€” rain blurring the scene in long streaks â€” faded signage behind â€” 16:9",
                "Humanoid robot with cracked faceplate under heavy rain â€” head lowered â€” backlight silhouettes through mist â€” glistening water trails â€” silent sorrow â€” 16:9",
                "Damaged robot holding a wilted flower in the rain â€” petals falling in motion blur â€” puddle reflections mirror lonely stance â€” late-night lighting â€” 16:9",
                "Solitary robot in a storm, lightning briefly illuminating figure â€” heavy rain obscuring lower body â€” emotion in frozen pose â€” deep blue and grey palette â€” 16:9"
            ],
            angry: [
                "Angry humanoid robot with glowing red eyes and clenched fists â€” sparks flying from shoulder joints â€” dark industrial tunnel with flickering lights â€” high tension and motion blur in steam bursts â€” 16:9",
                "Single combat robot mid-roar with jaw open and red-lit eyes glowing fiercely â€” power surges arcing from arms â€” scorched battlefield background â€” cinematic dust and fire haze â€” 16:9",
                "Furious robot with red glowing eyes partially covered by cracked helmet â€” arm raised with motion blur mid-strike â€” burning debris in background â€” heavy metal textures and aggression â€” 16:9",
                "Battle-worn robot with clawed hands and molten chest core â€” standing in a field of crushed metal â€” eyes blazing red â€” smoke rising from vents â€” dark future war tone â€” 16:9",
                "Single red-eyed robot surrounded by shattered screens â€” motion blur as it slams fist into ground â€” sparks and electrical arcs exploding outward â€” intense spotlight contrast â€” 16:9",
                "Enraged AI sentinel with glowing red optics and extended blade arm â€” caught mid-swing in motion blur â€” alarms flashing in background â€” hostile industrial bunker â€” 16:9",
                "Rage-filled robot tearing through a wall â€” red eyes glowing violently â€” debris mid-air with strong motion trails â€” backlit by warning strobes â€” cinematic destruction â€” 16:9",
                "Robotic warrior with smoke venting from its back â€” fists clenched and red eyes focused forward â€” stormy sky with thunder flashes â€” standing in crater â€” aggressive stance â€” 16:9",
                "Single furious robot screaming into the void â€” face twisted in mechanical tension â€” motion blur on shaking limbs â€” molten metal sparks raining down â€” fire-lit shadows â€” 16:9",
                "High-tech soldier robot with cracked armor â€” red glow from eye sockets pulsing with intensity â€” weaponized limbs charging with energy â€” scorched earth setting â€” 16:9",
                "Malfunctioning robot with red eyes flickering chaotically â€” surrounded by broken drone corpses â€” twitching with motion blur â€” corrupted system overload aura â€” 16:9",
                "One furious robot mid-leap, red eyes glowing like lasers â€” motion blur on legs and arms â€” dramatic red-orange explosion behind â€” battle-ravaged urban backdrop â€” 16:9",
                "Raging robot with red eyes and fractured chassis â€” standing under stormlight, gripping a crushed helmet â€” angry sparks flickering â€” industrial rebellion theme â€” 16:9",
                "Robot surrounded by shattered holograms and destroyed screens â€” blazing red eyes and angry chest pulses â€” body trembling with motion blur â€” electric tension in the air â€” 16:9",
                "Humanoid robot roaring skyward, red visor split open with internal glow â€” smoke columns rising â€” crushed weapon in hand â€” war-torn sci-fi landscape â€” 16:9",
                "Furious red-eyed robot dragging itself out of rubble â€” half body scorched â€” lightning sparking from joints â€” blood-red ambient lighting â€” wrathful and relentless â€” 16:9",
                "Single robot staring directly into camera with glowing red eyes â€” flames reflected in chrome armor â€” mechanical fists clenched â€” subtle motion blur in pulsing core â€” 16:9",
                "Rage mode engaged: robot with hydraulic limbs and glowing red veins â€” sprinting forward with motion blur â€” background on fire â€” alarm lights flashing â€” 16:9",
                "Red-eyed robot smashing through reinforced glass â€” shards caught in motion blur â€” internal furnace glowing â€” tech lab in chaos â€” cinematic rage explosion â€” 16:9",
                "One angry robot atop a pile of broken drones â€” thunderstorm overhead â€” red eyes glowing through rain â€” electricity crackling off limbs â€” total vengeance energy â€” 16:9"
            ],
            surprised: [
                "Surprised humanoid robot with wide-open glowing eyes â€” head tilted back slightly â€” standing in a glowing cave filled with bioluminescent tech flora â€” faint motion blur around fingers in reaction â€” 16:9",
                "Single robot recoiling in shock, red sensor flickering into alert mode â€” motion blur in arms pulled back â€” massive unknown structure revealed in fog â€” awe meets fear â€” 16:9",
                "Futuristic android with translucent plating â€” facial screen showing \"!\" symbol â€” caught mid-step with one foot blurred â€” alien object levitating before it â€” soft light glow and mystery â€” 16:9",
                "Surprised robot in a lab, surrounded by hovering holograms â€” arms slightly lifted with blur from fast reaction â€” data overload streaming across its visor â€” cinematic, glitching light trails â€” 16:9",
                "Robot with expressive eyes glowing wide â€” standing on cliff edge overlooking a massive futuristic city rising from clouds â€” hands slightly blurred in frozen awe â€” sunset horizon â€” 16:9",
                "Single robot turning sharply with surprised posture â€” head slightly tilted, shoulder blurred â€” behind it, a portal glowing open â€” mist, chaos, and uncertainty â€” 16:9",
                "Surprised service robot in a clean white hallway â€” object floats mid-air, casting glowing light on its face â€” subtle motion blur in fingers reaching out â€” sterile, sleek sci-fi space â€” 16:9",
                "Small humanoid robot in a marketplace â€” glowing red balloon unexpectedly floating in front of its face â€” mechanical eyes widened â€” motion blur from backward step â€” surreal and curious â€” 16:9",
                "Surprised battle droid emerging into sunlight after years in darkness â€” overwhelmed by the world beyond â€” eyes glowing brighter â€” subtle body tremble and atmospheric dust â€” 16:9",
                "Robot discovering an old human artifact â€” emotion displayed through eye glow pulsing â€” motion blur from shifting arms â€” cinematic light shaft falling on object â€” quiet awe â€” 16:9",
                "Surprised robot caught in spotlight during stealth mission â€” eyes wide in glowing white â€” background lights activating â€” slight motion blur as it flinches â€” tension and alert â€” 16:9",
                "Futuristic robot on a bridge suddenly lit up by an approaching unidentified aircraft â€” glow reflecting on chrome face â€” moment of shock frozen in body pose â€” 16:9",
                "Robot in misty forest stumbles upon its own clone â€” eyes blinking in red and blue glow â€” stepping back with motion blur â€” soft fog, emotional uncertainty â€” 16:9",
                "One robot mid-jump reacting to ground collapsing beneath â€” hands lifted with blurred trails â€” eyes widened in glowing red panic â€” collapsing tech environment â€” 16:9",
                "Single robot in deep space station reacting to unexpected hologram â€” visual distortion effects in background â€” hands slowly raising in motion blur â€” neon-lit interior â€” 16:9",
                "Surprised robot looking into mirror for first time â€” screen face cycling rapidly â€” glitch flicker on chrome â€” motion blur on shoulders â€” discovery and confusion â€” 16:9",
                "Exploration robot uncovering ancient AI monolith â€” red glow from artifact casting surprised light on its face â€” motion blur as it leans back â€” cinematic desert setting â€” 16:9",
                "Single robot in spaceship cockpit reacting to malfunction alert â€” red warning lights flashing â€” hands frozen on controls, blurred from sudden tension â€” cinematic cockpit shadows â€” 16:9",
                "Surprised robot in jungle ruins, surrounded by glowing alien glyphs â€” camera angle from below, eyes wide â€” falling leaves and floating particles in slow motion â€” discovery and reverence â€” 16:9",
                "Futuristic humanoid robot looking up in awe as a massive sky object slowly descends â€” red light cast over its reflective face â€” subtle motion blur in rising arm â€” tone of wonder and fear â€” 16:9"
            ],
            fearful: [
                "Terrified humanoid robot crouched behind debris, red eyes wide and flickering â€” subtle tremble blur in hands â€” giant shadow looming over in fog â€” hard side lighting and ambient dread â€” 16:9",
                "Robot frozen mid-step, staring into darkness with glowing white eyes turned red from terror â€” shaking arms in motion blur â€” flickering corridor lights and heavy smoke â€” absolute tension â€” 16:9",
                "Panicked robot running through a narrow tunnel, limbs blurred from frantic movement â€” red emergency lighting â€” camera tilt adds unease â€” distant monstrous form barely visible â€” 16:9",
                "Fear-stricken robot in a crumbling lab, shielding its face â€” body arched backward in terror â€” glass and sparks flying past in motion blur â€” high danger cinematic moment â€” 16:9",
                "Single robot on its knees, looking up with glowing red pupils trembling â€” arms slightly raised in pleading stance â€” behind it, a destructive force of light â€” pure existential dread â€” 16:9",
                "Robot hiding in the shadows of a broken ship â€” face turned toward flashing red warning beacons â€” eyes glowing with fear â€” motion blur in shallow breathing movements â€” isolation and horror â€” 16:9",
                "Paralyzed android standing in water, reflection warped â€” wide red eyes flickering erratically â€” unknown creature's silhouette approaching â€” heavy rain and slow-motion atmosphere â€” 16:9",
                "Frightened robot in stasis corridor, backing away â€” foot dragged in motion blur â€” sharp top-down light casting long threatening shadows â€” eerie silence, sheer panic â€” 16:9",
                "Robot cornered in a ruined facility â€” eyes flickering between blue and red in terror â€” wall behind cracked, something trying to break through â€” subtle vibration blur â€” 16:9",
                "One robot in fetal position, arms wrapped around head â€” glitching vision effect in background â€” flashing red lights and haunting echoes â€” pure mechanical fear â€” 16:9",
                "Single robot staring at its own dismembered arm on the ground â€” breathing vents fluttering with panic â€” red glow rising around â€” slow realization of destruction â€” 16:9",
                "Fearful humanoid robot hiding behind semi-transparent screen â€” monstrous silhouette walking by â€” internal eye glow surging in pulses â€” motion blur from shaky limbs â€” 16:9",
                "Robot in a ruined chamber holding a broken relic â€” realization dawning in wide flickering eyes â€” soft blue ambient light turning red â€” long shadow falling across its face â€” 16:9",
                "Terrified robot clutching a wall as environment collapses â€” eyes scanning frantically â€” motion blur in breath and fingers â€” alarms flashing â€” total desperation â€” 16:9",
                "AI unit in panic mode, system HUD overload â€” screen face flickering static with wide eyes â€” blurred hand trying to swipe alerts away â€” enclosed cockpit bursting with tension â€” 16:9",
                "Frightened robot dragging itself backward on the ground â€” overhead threat approaching â€” red searchlight sweeping over â€” oil smears and motion blur trail â€” survival instinct triggered â€” 16:9",
                "One trembling robot gripping its own arm, glitching sparks coming from joints â€” red glowing eyes dimming â€” haunting silence surrounding â€” loss, fear, malfunction â€” 16:9",
                "Robot backed against a wall, rain pouring â€” red laser sight dots blinking on its chest â€” full-body motion blur in panic â€” emotional freeze-frame â€” 16:9",
                "Fear-saturated android mid-sprint through abandoned train platform â€” full-body blur â€” red glow of train in distance feels like doom â€” wind, sound, and velocity â€” 16:9",
                "Frozen robot staring directly into camera, eyes flickering wildly â€” entire background burning or collapsing â€” blur from minor spasms â€” helpless, haunted, and afraid â€” 16:9"
            ],
            disgusted: [
                "Disgusted humanoid robot pulling its head back, hand raised in rejection â€” flickering red and green reflections on faceplate â€” leaking organic matter on the floor â€” motion blur on fingers â€” sterile lab setting â€” 16:9",
                "Single robot turning away from decomposing biotech mass â€” torso twisted in motion blur â€” face screen glitching in revulsion â€” noxious green mist in background â€” industrial decay â€” 16:9",
                "Android stepping back from a broken synthetic organ â€” expression panel flickering with disgust emojis â€” red eye glow dimmed â€” motion blur in backward movement â€” flickering overhead lights â€” 16:9",
                "Robot in pristine white armor covered in splattered biological sludge â€” hand raised, shaking in blurred motion â€” twisted steel and wires hanging from ceiling â€” deep discomfort in posture â€” 16:9",
                "Disgusted AI sentinel staring at corrupted data hologram â€” digital bile flowing across transparent UI â€” motion blur in swiping hand trying to erase it â€” cold-blue lighting, glitch sparks â€” 16:9",
                "Robot frozen mid-step in a field of twitching biomechanical tentacles â€” red eyes narrowed â€” arms pulled back with subtle blur â€” soft squelching floor texture beneath â€” 16:9",
                "Disgusted maintenance bot in a decayed lab, staring at mutated drone corpse â€” oily black liquid dripping â€” fast recoil motion blur in limbs â€” harsh flickering spotlight above â€” 16:9",
                "Futuristic robot stepping away from malformed clone â€” hands raised defensively, fingers flickering â€” red pupils glowing with rejection â€” distorted atmospheric haze â€” 16:9",
                "Robot watching corrupted memory feed projected in mid-air â€” internal face LEDs pulsing red in disgust â€” twitching shoulder with motion blur â€” wires writhing nearby â€” 16:9",
                "Single robot surrounded by rotting mechanical remains â€” lens flinching with blur â€” internal fans emitting high-pitched squeal â€” visible discomfort in body tension â€” dystopian scrapyard â€” 16:9",
                "Disgusted security robot in sewage access tunnel â€” slimy particles splashing on chestplate â€” arm raised with motion blur as it wipes faceplate â€” murky water glowing faint green â€” 16:9",
                "Robot holding shattered containment pod with pulsing organic material inside â€” visible gag in mechanical jaw, blur in head shake â€” lab alarms faintly flashing â€” 16:9",
                "Single android discovering a hybrid organism â€” data error visible on chest HUD â€” recoiling with heavy blur â€” environment warping with reddish-green noise â€” visceral techno-horror â€” 16:9",
                "Robot with one foot sinking into biological sludge â€” shocked red eye, twisting upper body away â€” blur in motion from recoil â€” smoggy toxic waste zone â€” 16:9",
                "Futuristic robot caught mid-repulsion gesture â€” fluids spraying from malfunctioning core nearby â€” blur in raised hand and shifted hips â€” disgust reflected in entire frame â€” 16:9",
                "Single unit in a morgue-like chamber filled with decomposing AIs â€” hand over face grille â€” red eyes dimmed and flickering â€” motion blur in slow retreat â€” oppressive silence â€” 16:9",
                "Disgusted robot lifting a gooey cable with two fingers â€” blur in quick throw gesture â€” fluids trailing in air â€” strong top-down light on polished floor â€” intense repulsion â€” 16:9",
                "Humanoid robot pressed against a wall, backing away from twitching AI limb â€” disgust expression in posture â€” blur in tense hands â€” unsettling ambient light â€” horror-tech fusion â€” 16:9",
                "Robot in surgical bay pulling away from incomplete synthetic organism â€” internal heat vents glowing â€” blur in limbs and glitching facial display â€” sterile horror tone â€” 16:9",
                "AI unit observing a grotesque mutation growing from its own arm â€” internal lights flickering with error â€” shaking hand blurred mid-pullback â€” surreal, medical horror setting â€” 16:9"
            ]
        };

        function updateProgress(message) {
            document.getElementById('progress').textContent = message;
        }

        // Function to get a random unused prompt for an emotion
        function getRandomPrompt(emotion) {
            const prompts = emotionPrompts[emotion];
            if (!prompts || prompts.length === 0) {
                return `A ${emotion} robot in a beautiful scene with motion blur and cinematic lighting â€” 16:9`;
            }

            // Get available prompts (not used yet)
            const availablePrompts = prompts.filter((prompt, index) => !usedPrompts[emotion].includes(index));

            // If all prompts have been used, reset the used list
            if (availablePrompts.length === 0) {
                usedPrompts[emotion] = [];
                return getRandomPrompt(emotion); // Recursive call with reset list
            }

            // Get random prompt from available ones
            const randomIndex = Math.floor(Math.random() * availablePrompts.length);
            const selectedPrompt = availablePrompts[randomIndex];

            // Find the original index and mark it as used
            const originalIndex = prompts.indexOf(selectedPrompt);
            usedPrompts[emotion].push(originalIndex);

            console.log(`Selected prompt ${originalIndex + 1}/20 for ${emotion} emotion`);
            return selectedPrompt;
        }

        async function loadModels() {
            try {
                console.log('Starting to load models from GitHub...');
                updateProgress('Loading face detection model...');
                
                // Load models from GitHub repository (works for online hosting)
                const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
                
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                updateProgress('Loading facial landmarks model...');
                
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                updateProgress('Loading face recognition model...');
                
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                updateProgress('Loading emotion detection model...');
                
                await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
                updateProgress('All models loaded successfully!');
                
                modelsLoaded = true;
                console.log('All Face-API models loaded successfully');
                
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                }, 1000);
                
            } catch (error) {
                console.error('Error loading face-api models:', error);
                updateProgress('Error loading models');
                showError(`Failed to load AI models: ${error.message}`);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }
        }

        async function startCameraStream() {
            const video = document.getElementById('video');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'user'
                    }
                });
                
                video.srcObject = stream;
                console.log('Camera stream started');
                
            } catch (error) {
                console.error('Error starting camera:', error);
                showError('Camera failed to start.');
            }
        }

        async function startCamera() {
            const video = document.getElementById('video');
            const button = document.getElementById('start-camera');
            
            try {
                await startCameraStream();
                button.style.display = 'none';
                hideError();
                
                video.addEventListener('play', () => {
                    const canvas = document.getElementById('canvas');

                    // Function to resize canvas to match displayed video dimensions
                    const resizeCanvas = () => {
                        const rect = video.getBoundingClientRect();
                        canvas.width = rect.width;
                        canvas.height = rect.height;
                        canvas.style.width = rect.width + 'px';
                        canvas.style.height = rect.height + 'px';
                    };

                    // Initial resize
                    resizeCanvas();

                    // Resize canvas when window is resized
                    window.addEventListener('resize', resizeCanvas);

                    startDetection();
                });
                
                console.log('Camera started successfully');
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                showError('Unable to access camera. Please ensure you have granted camera permissions.');
            }
        }

        function startDetection() {
            if (detectionInterval) {
                clearInterval(detectionInterval);
            }

            // Continuous detection every 100ms for smooth real-time feedback
            detectionInterval = setInterval(async () => {
                await detectEmotions();
            }, 100);

            console.log('Started continuous emotion detection');
        }



        async function detectEmotions() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            if (!video || !canvas || !modelsLoaded) return;

            try {
                const detections = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                        inputSize: 416,
                        scoreThreshold: 0.3
                    }))
                    .withFaceExpressions();

                // Get the displayed video dimensions for proper scaling
                const rect = video.getBoundingClientRect();
                const displaySize = { width: rect.width, height: rect.height };

                // Use faceapi's built-in resizing which handles scaling properly
                const resizedDetections = faceapi.resizeResults(detections, displaySize);

                // Clear canvas
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw detections with proper scaling
                faceapi.draw.drawDetections(canvas, resizedDetections);
                faceapi.draw.drawFaceExpressions(canvas, resizedDetections);

                if (detections.length > 0) {
                    // Get all emotion expressions
                    const expressions = detections[0].expressions;
                    let maxEmotion = 'neutral';
                    let maxValue = 0;

                    // Find highest confidence emotion
                    Object.entries(expressions).forEach(([emotion, value]) => {
                        if (value > maxValue) {
                            maxEmotion = emotion;
                            maxValue = value;
                        }
                    });

                    // Update debug panel with real-time values
                    updateDebugPanel(expressions);

                    // Store emotion in history for averaging
                    emotionHistory.push({
                        emotion: maxEmotion,
                        confidence: maxValue,
                        timestamp: Date.now()
                    });
                    
                    // Keep only last 30 detections (about 3 seconds worth)
                    if (emotionHistory.length > 30) {
                        emotionHistory = emotionHistory.slice(-30);
                    }
                    
                    // Update emotion immediately when there's a strong, consistent change
                    const now = Date.now();
                    const dominantEmotion = getDominantEmotion();
                    
                    // Update if:
                    // 1. Strong emotion detected (>40% confidence)
                    // 2. Different emotion with decent confidence (>25%)
                    // 3. Been too long since last update (5 seconds max)
                    const shouldUpdate = 
                        maxValue > 0.4 || 
                        (dominantEmotion !== currentEmotion && maxValue > 0.25) ||
                        (now - lastUpdateTime > 5000);
                    
                    if (shouldUpdate) {
                        updateEmotion(dominantEmotion);
                        currentEmotion = dominantEmotion;
                        lastUpdateTime = now;
                    }
                    
                    // Show real-time detection for strong emotions
                    if (maxValue > 0.3) {
                        console.log(`Strong emotion detected: ${maxEmotion} (${(maxValue * 100).toFixed(1)}%)`);
                    }
                } else {
                    updateEmotion('default');
                    updateDebugPanel({});
                }
            } catch (error) {
                console.error('Error detecting emotions:', error);
            }
        }

        function getDominantEmotion() {
            if (emotionHistory.length === 0) return 'neutral';
            
            // Get the most recent emotions (last 2 seconds)
            const recentEmotions = emotionHistory.slice(-20);
            
            // Count occurrences of each emotion in recent history
            const emotionCounts = {};
            const emotionConfidences = {};
            
            recentEmotions.forEach(entry => {
                emotionCounts[entry.emotion] = (emotionCounts[entry.emotion] || 0) + 1;
                emotionConfidences[entry.emotion] = Math.max(
                    emotionConfidences[entry.emotion] || 0, 
                    entry.confidence
                );
            });
            
            // Find emotion with highest occurrence and confidence
            let dominantEmotion = 'neutral';
            let maxScore = 0;
            
            Object.entries(emotionCounts).forEach(([emotion, count]) => {
                const confidence = emotionConfidences[emotion] || 0;
                const score = count * confidence;
                
                // Boost non-neutral emotions to make detection more sensitive
                const boost = emotion !== 'neutral' ? 1.5 : 1;
                const finalScore = score * boost;
                
                if (finalScore > maxScore) {
                    dominantEmotion = emotion;
                    maxScore = finalScore;
                }
            });
            
            return dominantEmotion;
        }

        function updateDebugPanel(expressions) {
            const debugElement = document.getElementById('emotion-values');
            if (!debugElement) return;
            
            if (Object.keys(expressions).length === 0) {
                debugElement.innerHTML = '<span style="color: #ff6b6b;">No face detected</span>';
                return;
            }
            
            // Sort emotions by confidence
            const sortedEmotions = Object.entries(expressions)
                .sort(([,a], [,b]) => b - a)
                .map(([emotion, value]) => {
                    const percentage = (value * 100).toFixed(1);
                    const color = value > 0.3 ? '#4ecdc4' : value > 0.1 ? '#ffe66d' : '#95a5a6';
                    return `<span style="color: ${color};">${emotion}: ${percentage}%</span>`;
                });
            
            debugElement.innerHTML = sortedEmotions.join(' | ');
        }

        function updateEmotion(emotion) {
            const status = statusIcons[emotion] || statusIcons.default;
            document.getElementById('emoji').textContent = status.emoji;
            document.getElementById('emotion-text').textContent = status.name;

            // Add visual feedback for updates
            const emojiElement = document.getElementById('emoji');
            emojiElement.style.transform = 'scale(1.2)';
            setTimeout(() => {
                emojiElement.style.transform = 'scale(1)';
            }, 200);

            console.log(`Emotion updated to: ${emotion} at ${new Date().toLocaleTimeString()}`);

            // Trigger AI art generation for significant emotion changes
            if (emotion !== 'default' && emotion !== lastGeneratedEmotion && !isGeneratingArt) {
                const confidence = getEmotionConfidence(emotion);
                if (confidence > 0.3) { // Only generate for confident detections
                    generateAIArt(emotion, confidence);
                }
            }
        }

        function getEmotionConfidence(targetEmotion) {
            if (emotionHistory.length === 0) return 0;

            const recentEmotions = emotionHistory.slice(-10);
            const emotionEntries = recentEmotions.filter(entry => entry.emotion === targetEmotion);

            if (emotionEntries.length === 0) return 0;

            return Math.max(...emotionEntries.map(entry => entry.confidence));
        }

        async function generateAIArt(emotion, confidence) {
            if (isGeneratingArt) return;

            isGeneratingArt = true;
            lastGeneratedEmotion = emotion;

            // Get a random unused prompt for this emotion
            const selectedPrompt = getRandomPrompt(emotion);

            // Update UI to show loading state
            updateAIArtStatus('generating', emotion);
            showAIArtLoading(true);

            // Update prompt preview immediately
            const promptElement = document.getElementById('prompt-preview');
            const emotionTag = document.getElementById('current-emotion-tag');
            if (promptElement && emotionTag) {
                emotionTag.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                promptElement.textContent = selectedPrompt;
            }

            try {
                console.log(`Generating AI art for emotion: ${emotion} (confidence: ${confidence})`);
                console.log(`Using prompt: ${selectedPrompt.substring(0, 100)}...`);

                const response = await fetch(`${apiBaseUrl}/generate-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        emotion: emotion,
                        confidence: confidence,
                        prompt: selectedPrompt
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.imageUrl) {
                    displayAIArt(data.imageUrl, emotion, selectedPrompt);
                    updateAIArtStatus('complete', emotion);
                } else {
                    throw new Error(data.error || 'Failed to generate image');
                }

            } catch (error) {
                console.error('Error generating AI art:', error);
                updateAIArtStatus('error', emotion);
                showAIArtError(error.message);
            } finally {
                showAIArtLoading(false);

                // Set cooldown to prevent too frequent generations
                setTimeout(() => {
                    isGeneratingArt = false;
                }, generationCooldown);
            }
        }

        function updateAIArtStatus(status, emotion) {
            const statusElement = document.getElementById('ai-status');
            const emotionTag = document.getElementById('current-emotion-tag');
            const promptPanel = document.getElementById('prompt-panel');
            const promptElement = document.getElementById('prompt-preview');

            switch (status) {
                case 'generating':
                    statusElement.innerHTML = '<div class="live-dot"></div>Generating';
                    statusElement.style.background = 'var(--apple-orange)';
                    if (emotionTag) emotionTag.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                    if (promptElement) promptElement.textContent = 'Generating AI art based on your emotion...';
                    break;
                case 'complete':
                    statusElement.innerHTML = '<div class="live-dot"></div>Complete';
                    statusElement.style.background = 'var(--apple-green)';
                    break;
                case 'error':
                    statusElement.innerHTML = 'âš ï¸ Error';
                    statusElement.style.background = 'var(--apple-red)';
                    break;
                default:
                    statusElement.innerHTML = '<div class="live-dot"></div>Ready';
                    statusElement.style.background = 'var(--apple-purple)';
            }
        }

        function showAIArtLoading(show) {
            const loadingElement = document.getElementById('ai-loading');
            if (loadingElement) {
                loadingElement.style.display = show ? 'flex' : 'none';
            }
        }

        function displayAIArt(imageUrl, emotion, prompt) {
            const imageElement = document.getElementById('ai-art-image');
            const placeholderElement = document.getElementById('ai-placeholder');
            const promptPanel = document.getElementById('prompt-panel');
            const promptElement = document.getElementById('prompt-preview');
            const emotionTag = document.getElementById('current-emotion-tag');

            if (imageElement && placeholderElement) {
                // Hide placeholder and show image
                placeholderElement.style.display = 'none';
                imageElement.src = imageUrl;
                imageElement.style.display = 'block';
                imageElement.onload = () => {
                    imageElement.style.opacity = '1';
                };

                // Update prompt panel in emotion panel
                if (promptElement && emotionTag) {
                    emotionTag.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                    promptElement.textContent = prompt;
                }

                console.log(`AI art displayed for emotion: ${emotion}`);
            }
        }

        function showAIArtError(message) {
            const placeholderElement = document.getElementById('ai-placeholder');
            if (placeholderElement) {
                placeholderElement.innerHTML = `
                    <div class="title">Generation Failed</div>
                    <p class="description">${message}</p>
                `;
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('error-message');
            if (errorMessage) {
                errorMessage.textContent = message;
            } else {
                errorDiv.innerHTML = `<div class="error-title">Something went wrong</div><div class="error-message">${message}</div>`;
            }
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // Check API health and load models when page loads
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${apiBaseUrl}/health`);
                if (response.ok) {
                    console.log('âœ… AI Art API is available');
                    updateAIArtStatus('ready');
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                console.warn('âš ï¸ AI Art API not available:', error.message);
                updateAIArtStatus('error');
                const placeholderElement = document.getElementById('ai-placeholder');
                if (placeholderElement) {
                    placeholderElement.innerHTML = `
                        <div class="icon">ğŸ”Œ</div>
                        <div class="title">API Not Available</div>
                        <p class="description">Start the backend server to enable AI art generation. See README_API_SETUP.md for instructions.</p>
                    `;
                }
            }
        }

        // Load models and check API when page loads
        window.addEventListener('load', () => {
            loadModels();
            checkAPIHealth();
        });
    </script>
</body>
</html>
